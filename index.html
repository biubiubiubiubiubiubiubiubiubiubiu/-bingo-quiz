<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#F2F2F7" id="theme-color-meta">
    <title>æ–Œç‹—ï¼é€šå…³ï¼</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png"> <!-- å»ºè®®ä½ è‡ªå·±æ”¾ä¸€ä¸ª192x192çš„icon.pngåœ¨åŒçº§ç›®å½• -->

    <!-- å¼•å…¥ SheetJS ç”¨äºè§£æ Excel -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> -->

    <style>
        /* --- æ ·å¼å®šä¹‰ --- */
        :root {
            --primary: #007AFF; --primary-light: rgba(0, 122, 255, 0.1);
            --success: #34C759; --success-light: rgba(52, 199, 89, 0.1);
            --danger: #FF3B30; --danger-light: rgba(255, 59, 48, 0.1);
            --bg-body: #F2F2F7; --bg-card: #FFFFFF; --bg-input: #E5E5EA;
            --text-main: #1C1C1E; --text-sub: #8E8E93; --text-inverse: #FFFFFF;
            --shadow: 0 4px 16px rgba(0,0,0,0.04);
            --radius-l: 20px; --safe-area-bottom: env(safe-area-inset-bottom);
        }
        [data-theme="everforest"] {
            --primary: #7FBBB3; --primary-light: rgba(127, 187, 179, 0.15);
            --success: #A7C080; --success-light: rgba(167, 192, 128, 0.15);
            --danger: #E67E80; --danger-light: rgba(230, 126, 128, 0.15);
            --bg-body: #272E33; --bg-card: #2E383C; --bg-input: #374145;
            --text-main: #D3C6AA; --text-sub: #9DA9A0; --text-inverse: #272E33;
            --shadow: 0 4px 16px rgba(0,0,0,0.2);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; background: var(--bg-body); color: var(--text-main); padding-bottom: calc(80px + var(--safe-area-bottom)); transition: background 0.3s; }

        .container {
            padding: 0 20px;
        }

        /* å¯¼èˆªæ  */
        .nav-bar { padding: 40px 20px 10px; display: flex; justify-content: space-between; align-items: center; background: var(--bg-body); position: sticky; top:0; z-index: 90; }
        .nav-title { font-size: 28px; font-weight: 800; }
        .bingo-badge { background: linear-gradient(135deg, var(--primary), #00C7BE); color: #fff; padding: 2px 8px; border-radius: 8px; font-size: 14px; margin-left: 8px; vertical-align: middle;}

        /* å¡ç‰‡é€šç”¨ */
        .ios-card { background: var(--bg-card); border-radius: var(--radius-l); padding: 20px; box-shadow: var(--shadow); margin-bottom: 20px; position: relative; transition: 0.2s; }
        .ios-card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.08); }
        
        /* æŒ‰é’® */
        .btn { width: 100%; padding: 15px; border: none; border-radius: 15px; font-size: 17px; font-weight: 600; cursor: pointer; transition: 0.2s; display:flex; align-items:center; justify-content:center; gap:8px;}
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger-light); color: var(--danger); }
        .btn-ghost { background: var(--bg-input); color: var(--text-sub); }
        .btn-float { position: fixed; bottom: 40px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; font-size: 30px; box-shadow: 0 8px 20px rgba(0, 122, 255, 0.4); z-index: 100; display: flex; align-items: center; justify-content: center; }

        /* åˆ—è¡¨ */
        .db-list-item { display: flex; justify-content: space-between; align-items: center; padding: 20px; border: none; }
        .db-info h4 { margin: 0 0 8px 0; font-size: 18px; font-weight: 600; }
        .db-info p { margin: 0; font-size: 14px; color: var(--text-sub); }
        
        /* å†å²è®°å½•é¡¹ */
        .history-item { background: var(--bg-input); padding: 15px; border-radius: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .score-badge { font-weight: 800; font-size: 20px; }
        .score-high { color: var(--success); }
        .score-low { color: var(--danger); }

        /* ç­”é¢˜åŒº */
        .option-row { padding: 15px; background: var(--bg-input); border-radius: 15px; margin-bottom: 10px; display: flex; align-items: center; cursor: pointer; border: 2px solid transparent; transition:0.2s; }
        .option-row.selected { background: var(--primary-light); border-color: var(--primary); }
        .option-circle { width: 26px; height: 26px; border-radius: 50%; border: 2px solid var(--text-sub); margin-right: 15px; display: flex; justify-content: center; align-items: center; font-size: 14px; font-weight: bold; flex-shrink: 0; }
        .selected .option-circle { background: var(--primary); border-color: var(--primary); color: white; }
        
        /* é”™é¢˜/å›çœ‹æ ·å¼ */
        .ios-card.correct { border: 2px solid var(--success); }
        .ios-card.wrong { border: 2px solid var(--danger); }
        .review-mode .selected .option-circle { color: white; } 
        .review-mode .ios-card.correct .selected .option-circle { background: var(--success); border-color: var(--success); }
        .review-mode .ios-card.wrong .selected .option-circle { background: var(--danger); border-color: var(--danger); }
        .review-mode .option-row.correct-answer { background: var(--success-light); border: 2px dashed var(--success); }

        /* Modal */
        .modal-mask { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal-box { background: var(--bg-card); width: 90%; max-width: 350px; border-radius: 25px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); animation: popIn 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Loading */
        .loader-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg-body); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; display:none;}
        .spinner { width: 45px; height: 45px; border: 5px solid var(--primary-light); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #sheet-selection-container label { display: block; padding: 10px; border-radius: 8px; cursor: pointer; }
        #sheet-selection-container label:hover { background: var(--bg-input); }
        #sheet-selection-container input { margin-right: 10px; }

        /* Select dropdowns with arrow */
        select.btn-ghost {
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%238E8E93%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 10px;
            padding-right: 40px !important; /* Make space for arrow */
        }
        [data-theme="everforest"] select.btn-ghost {
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%239DA9A0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
        }

        /* Hover effects */
        .btn-primary:hover, .btn-success:hover {
            filter: brightness(1.1);
        }
        .btn-ghost:not(select):hover { /* Exclude select to avoid conflict with arrow */
            background: var(--bg-card); /* A slightly different shade */
        }

        .nav-bar .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
        }
        .nav-bar .btn-icon svg {
            width: 20px;
            height: 20px;
        }
        .nav-bar .btn-icon.btn-delete {
            color: var(--danger);
        }
        .nav-bar .btn-icon.btn-delete:hover {
            background: var(--danger-light);
        }

        /* Quiz View Header */
        #view-quiz .nav-bar {
            background: rgba(242, 242, 247, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--bg-input);
            padding: 10px 20px;
            padding-top: calc(10px + env(safe-area-inset-top)); /* For iOS notch */
        }
        [data-theme="everforest"] #view-quiz .nav-bar {
            background: rgba(46, 56, 60, 0.7);
        }

        @media (min-width: 600px) {
            .container {
                max-width: 800px;
                margin: 0 auto;
            }
            .modal-box {
                max-width: 400px;
            }
        }
    </style>
</head>
<body>

<!-- Loading -->
<div class="loader-overlay" id="global-loader">
    <div class="spinner"></div>
    <p style="color:var(--text-sub); margin-top:10px;" id="loader-text">çŒ›çŠ¬æŒ–æ˜ä¸­...</p>
</div>

<!-- VIEW 1: é¢˜åº“åˆ—è¡¨é¦–é¡µ -->
<div id="view-home" class="container" style="padding: 0 20px;">
    <div class="nav-bar" style="padding-left:0; padding-right:0;">
        <div>
            <div class="nav-title">æˆ‘çš„ç‹—çª <span class="bingo-badge">Pro</span></div>
            <div style="font-size:13px; color:var(--text-sub);">ç¦»çº¿å¯ç”¨ Â· æ— é™ç‹—çª Â· éšæ—¶å¤ç›˜</div>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-ghost btn-icon" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
        </div>
    </div>

    <div id="db-list-container">
        <!-- JS å¡«å……åˆ—è¡¨ -->
    </div>

    <div class="ios-card" id="empty-state" style="text-align:center; padding:40px 20px; display:none; cursor: pointer;" onclick="showImportModal()">
        <div style="font-size:40px; margin-bottom:10px;">ğŸ¦´</div>
        <h3 style="margin:0;">ç‹—çªç©ºç©ºå¦‚ä¹Ÿ</h3>
        <p style="color:var(--text-sub);">å¿«å»æŒ–ç‚¹æ–°éª¨å¤´ (+)ï¼Œæ”¯æŒè¡¨æ ¼æ–‡ä»¶</p>
    </div>

    <!-- æ‚¬æµ®æ·»åŠ æŒ‰é’® -->
    <div class="btn-float" onclick="showImportModal()">+</div>
</div>

<!-- VIEW 2: å•ä¸ªé¢˜åº“ä»ªè¡¨ç›˜ -->
<div id="view-dashboard" class="container" style="padding: 0 20px; display:none;">
    <div class="nav-bar" style="padding-left:0; padding-right:0;">
        <button class="btn btn-ghost btn-icon" onclick="goHome()" title="è¿”å›">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </button>
        <div style="font-weight:bold; font-size:16px; max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="dash-title">ç‹—çªè¯¦æƒ…</div>
        <button class="btn btn-ghost btn-icon btn-delete" onclick="deleteCurrentDb()" title="åˆ é™¤é¢˜åº“">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
        </button>
    </div>

    <div class="ios-card">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <div>
                <h2 style="margin:0; font-size:28px;" id="dash-count">0</h2>
                <div style="font-size:12px; color:var(--text-sub);">éª¨å¤´æ€»æ•°</div>
            </div>
            <div style="text-align:right;">
                <h2 style="margin:0; font-size:28px; color:var(--success);" id="dash-progress">0</h2>
                <div style="font-size:12px; color:var(--text-sub);">å•ƒéª¨å¤´è¿›åº¦</div>
            </div>
        </div>
        
        <div id="category-container" style="margin-bottom: 20px; border-top: 1px solid var(--bg-input); padding-top: 15px;">
            <label for="category-select" style="font-weight: bold; font-size: 14px; color: var(--text-sub); margin-bottom: 8px; display: block;">é€‰æ‹©åˆ†ç±»</label>
            <select id="category-select" class="btn btn-ghost" style="width:100%; -webkit-appearance: none; appearance: none; text-align: left;"></select>
        </div>

        <div style="display:flex; gap:10px; margin-bottom: 15px;">
            <button class="btn btn-primary" style="flex-grow: 1;" onclick="startQuiz('sequence')">æŒ‰é¡ºåºå•ƒ</button>
            <select id="sequence-count" class="btn btn-ghost" style="max-width: 100px; padding: 0 15px; -webkit-appearance: none; appearance: none; background-image: none;">
                <option value="10">10æ ¹</option>
                <option value="20">20æ ¹</option>
                <option value="50" selected>50æ ¹</option>
                <option value="100">100æ ¹</option>
                <option value="all">æ¢­å“ˆ</option>
            </select>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-success" style="flex-grow: 1;" onclick="startQuiz('random')">éšä¾¿åˆ¨ä¸€ä¸ª</button>
            <select id="random-count" class="btn btn-ghost" style="max-width: 100px; padding: 0 15px; -webkit-appearance: none; appearance: none; background-image: none;">
                <option value="10">10æ ¹</option>
                <option value="20" selected>20æ ¹</option>
                <option value="50">50æ ¹</option>
                <option value="100">100æ ¹</option>
                <option value="all">æ¢­å“ˆ</option>
            </select>
        </div>
        <div style="margin-top: 15px;">
            <button id="btn-wrong-answers" class="btn btn-danger" onclick="startWrongAnswerQuiz()">å•ƒç¡¬éª¨å¤´</button>
        </div>
        
        <div style="margin-top: 20px; border-top: 1px solid var(--bg-input); padding-top: 15px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="background: linear-gradient(135deg, #FF9500, #FFCC00); flex-grow: 1;" onclick="startMockExam()">æ¨¡æ‹Ÿå¼€å•ƒ</button>
            <select id="mock-exam-count" class="btn btn-ghost" style="max-width: 100px; padding: 0 15px; -webkit-appearance: none; appearance: none; background-image: none;">
                <option value="10">10æ ¹</option>
                <option value="20">20æ ¹</option>
                <option value="50" selected>50æ ¹</option>
                <option value="100">100æ ¹</option>
            </select>
        </div>
    </div>

    <div class="ios-card">
        <h4 style="margin:0 0 15px 0;">ğŸ“œ å•ƒéª¨å¤´çš„è®°å¿† (ç‚¹å‡»å›çœ‹)</h4>
        <div id="history-list">
            <!-- å†å²è®°å½• JS å¡«å…… -->
        </div>
        <button class="btn btn-ghost" id="no-history-btn" style="display:none;">è¿˜æ²¡å•ƒè¿‡å‘¢</button>
    </div>
</div>

<!-- VIEW 3: ç­”é¢˜/å›çœ‹ç•Œé¢ -->
<div id="view-quiz" style="display:none;">
    <div class="nav-bar">
        <div style="font-size:14px; font-weight:bold; color:var(--text-sub);" id="quiz-progress-text">1/20</div>
        <div style="font-size:16px; font-weight:bold; color:var(--primary);" id="quiz-timer"></div>
        <button class="btn btn-ghost btn-icon" onclick="exitQuiz()" title="é€€å‡º">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
    </div>

    <div class="container" style="padding: 0 16px 100px 16px;">
        <div id="quiz-container"></div>
    </div>

    <!-- æäº¤æŒ‰é’®åŒº -->
    <div id="quiz-fab-area" style="position:fixed; bottom:0; left:0; width:100%; padding:20px; background:var(--bg-body); border-top:1px solid var(--bg-input); display:flex; gap:10px;">
        <button class="btn btn-success" onclick="submitPaper()">æ±ªï¼äº¤å·ï¼</button>
    </div>
</div>

<!-- Modal: å¯¼å…¥ -->
<div class="modal-mask" id="modal-import">
    <div class="modal-box">
        <h3 style="margin-top:0;">æŒ–æ˜æ–°å®è—</h3>
        <p style="font-size:13px; color:var(--text-sub);">å®è—åœ°å›¾ (.xlsx/.xls) æŒ‡å—ï¼š<br>å¿…é¡»æ ‡æ˜ "é¢˜ç›®"ã€"ç­”æ¡ˆ" ç­‰...</p>
        
        <div id="import-feedback" style="margin-top:15px; display:none;">
            <div id="import-loader" class="spinner" style="display:none; margin: 0 auto 10px auto; width:25px; height:25px; border-width: 3px;"></div>
            <p id="import-status" style="font-size:13px; color:var(--danger); text-align:center; margin:0;"></p>
        </div>

        <input type="file" id="file-input" accept=".xlsx, .xls" style="display:none" onchange="handleFileSelect(this)">
        
        <button class="btn btn-primary" id="btn-select-file" onclick="document.getElementById('file-input').click()">ğŸ“‚ é€‰æ‹©è—å®å›¾</button>
        
        <div id="import-preview" style="display:none; margin-top:15px;">
            <div id="sheet-selection-container"></div>
            <div style="font-size:12px; color:var(--success);">å‘ç°å®è—ï¼</div>
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-ghost" onclick="closeImportModal()">æºœäº†æºœäº†</button>
            <button class="btn btn-primary" id="btn-confirm-import" style="display:none;" onclick="confirmImport()">åŸ‹è¿›ç‹—çª</button>
        </div>
    </div>
</div>

<!-- Modal: æˆç»©å• -->
<div class="modal-mask" id="modal-score">
    <div class="modal-box" style="text-align:center;">
        <h2 style="margin:10px 0;">å•ƒå®Œå•¦ï¼</h2>
        <div style="font-size:48px; font-weight:800; color:var(--primary);" id="result-score">90</div>
        <p style="color:var(--text-sub);">æ™ºåŠ›å€¼</p>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-ghost" onclick="exitQuiz()">å›ç‹—çª</button>
            <button class="btn btn-primary" onclick="enterReviewMode()">å›å‘³ä¸€ä¸‹</button>
        </div>
    </div>
</div>

<script>
    // --- PWA Service Worker æ³¨å†Œ ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').then(reg => {
                console.log('SW registered:', reg);
            }).catch(err => console.log('SW failed:', err));
        });
    }

    // --- æ ¸å¿ƒæ•°æ®ç»“æ„ ---
    // localStorage keys:
    // 'bingo_meta': [ {id, name, count, lastUsed} ]
    // 'bingo_db_[id]': [Question Array]
    // 'bingo_prog_[id]': int (sequence progress)
    // 'bingo_hist_[id]': [ {date, score, answers, type} ]

    let currentDb = null; // { id, name, questions, progress }
    let currentQuiz = []; // å½“å‰æ­£åœ¨åšçš„é¢˜
    let userAnswers = {}; // ç”¨æˆ·å½“å‰é€‰æ‹©
    let isReviewMode = false; // æ˜¯å¦å¤„äºå›çœ‹æ¨¡å¼

    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        initTheme();
        renderDbList();
    };

    // --- ä¸»é¢˜åˆ‡æ¢ ---
    function initTheme() {
        const t = localStorage.getItem('app_theme');
        if (t) document.documentElement.setAttribute('data-theme', t);
    }
    function toggleTheme() {
        const html = document.documentElement;
        const isDark = html.getAttribute('data-theme') === 'everforest';
        html.setAttribute('data-theme', isDark ? 'light' : 'everforest');
        localStorage.setItem('app_theme', isDark ? 'light' : 'everforest');
    }

    // --- é¦–é¡µï¼šé¢˜åº“åˆ—è¡¨é€»è¾‘ ---
    function getMeta() { return JSON.parse(localStorage.getItem('bingo_meta') || '[]'); }
    function saveMeta(list) { localStorage.setItem('bingo_meta', JSON.stringify(list)); }

    function renderDbList() {
        const list = getMeta();
        const container = document.getElementById('db-list-container');
        const empty = document.getElementById('empty-state');
        
        container.innerHTML = '';
        if (list.length === 0) {
            empty.style.display = 'block';
            return;
        }
        empty.style.display = 'none';

        list.sort((a,b) => b.lastUsed - a.lastUsed); // æœ€è¿‘ä½¿ç”¨çš„æ’å‰é¢

        list.forEach(db => {
            const div = document.createElement('div');
            div.className = 'db-list-item ios-card';
            div.innerHTML = `
                <div class="db-info">
                    <h4>${db.name}</h4>
                    <p>å…± ${db.count} æ ¹éª¨å¤´ Â· ä¸Šæ¬¡å¼€å•ƒ ${new Date(db.lastUsed).toLocaleDateString()}</p>
                </div>
                <div style="color:var(--text-sub);">á³</div>
            `;
            div.onclick = () => openDashboard(db.id);
            container.appendChild(div);
        });
    }

    // --- å¯¼å…¥é€»è¾‘ (SheetJS) ---
    let tempImportData = null;

    function showImportModal() {
        document.getElementById('modal-import').style.display = 'flex';
        // Reset state on open
        document.getElementById('import-feedback').style.display = 'none';
        document.getElementById('import-status').innerText = '';
        document.getElementById('import-loader').style.display = 'none';
        document.getElementById('import-preview').style.display = 'none';
        document.getElementById('btn-confirm-import').style.display = 'none';
        document.getElementById('btn-select-file').style.display = 'inline-flex';
    }
    function closeImportModal() { 
        document.getElementById('modal-import').style.display = 'none'; 
        document.getElementById('file-input').value = '';
    }

    function handleFileSelect(input) {
        const file = input.files[0];
        if (!file) return;

        const feedbackContainer = document.getElementById('import-feedback');
        const loader = document.getElementById('import-loader');
        const status = document.getElementById('import-status');
        const preview = document.getElementById('import-preview');

        feedbackContainer.style.display = 'block';
        loader.style.display = 'block';
        status.innerText = '';
        preview.style.display = 'none';
        document.getElementById('btn-confirm-import').style.display = 'none';
        document.getElementById('btn-select-file').style.display = 'none';

        const reader = new FileReader();
        reader.onload = function(e) {
            loader.style.display = 'none';
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                tempImportData = {};
                const sheetSelectionContainer = document.getElementById('sheet-selection-container');
                sheetSelectionContainer.innerHTML = '';

                workbook.SheetNames.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);
                    const parsedData = parseImportData(json);
                    if (parsedData.length > 0) {
                        tempImportData[sheetName] = parsedData;

                        const checkbox = document.createElement('div');
                        checkbox.innerHTML = `
                            <label>
                                <input type="checkbox" name="sheet" value="${sheetName}" checked>
                                ${sheetName} (${parsedData.length} æ ¹éª¨å¤´)
                            </label>
                        `;
                        sheetSelectionContainer.appendChild(checkbox);
                    }
                });

                if (Object.keys(tempImportData).length > 0) {
                    feedbackContainer.style.display = 'none';
                    preview.style.display = 'block';
                    document.getElementById('btn-confirm-import').style.display = 'inline-block';
                } else {
                    status.innerText = 'è§£æå¤±è´¥ï¼è¯·æ£€æŸ¥æ‚¨çš„ Excel æ–‡ä»¶ï¼Œç¡®ä¿å…¶ä¸­åŒ…å« "é¢˜ç›®" å’Œ "ç­”æ¡ˆ" åˆ—ã€‚';
                    document.getElementById('btn-select-file').style.display = 'inline-flex';
                }
            } catch (err) {
                console.error("File parsing error:", err);
                status.innerText = 'æ–‡ä»¶è¯»å–å‡ºé”™ï¼Œå¯èƒ½ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ Excel æ–‡ä»¶ã€‚';
                document.getElementById('btn-select-file').style.display = 'inline-flex';
            }
        };
        reader.onerror = function() {
            loader.style.display = 'none';
            status.innerText = 'æ— æ³•è¯»å–æ–‡ä»¶ã€‚';
            document.getElementById('btn-select-file').style.display = 'inline-flex';
        };
        reader.readAsArrayBuffer(file);
    }

    function parseImportData(json) {
        // æ™ºèƒ½æ˜ å°„å­—æ®µ (æ”¯æŒå¸¸è§åˆ—å)
        const parsed = json.map(row => {
            // å¯»æ‰¾é¢˜ç›®
            const qKey = Object.keys(row).find(k => /é¢˜ç›®|é—®é¢˜|Question/i.test(k));
            // å¯»æ‰¾ç­”æ¡ˆ
            const aKey = Object.keys(row).find(k => /ç­”æ¡ˆ|Answer/i.test(k));
            // å¯»æ‰¾è§£æ
            const eKey = Object.keys(row).find(k => /è§£æ|è§£é‡Š|Explanation/i.test(k));
            // å¯»æ‰¾é¢˜å‹
            const tKey = Object.keys(row).find(k => /é¢˜å‹|Type/i.test(k));
            // å¯»æ‰¾ç±»åˆ«
            const cKey = Object.keys(row).find(k => /ç±»åˆ«|åˆ†ç±»|Category/i.test(k));

            if (!qKey || !aKey) return null; // å…³é”®å­—æ®µç¼ºå¤±åˆ™è·³è¿‡

            // å¯»æ‰¾é€‰é¡¹
            const options = {};
            ['A','B','C','D','E','F'].forEach(opt => {
                const optKey = Object.keys(row).find(k => k.toUpperCase().trim() === `é€‰é¡¹${opt}` || k.toUpperCase().trim() === opt);
                if (optKey && row[optKey]) options[opt] = row[optKey];
            });

            // å¤„ç†ç­”æ¡ˆæ ¼å¼ (æ¸…æ´—éå­—æ¯å­—ç¬¦)
            let cleanAns = String(row[aKey]).toUpperCase().replace(/[^A-Z]/g, '');
            
            // ç‰¹æ®Šå¤„ç†ï¼šåˆ¤æ–­é¢˜
            if (Object.keys(options).length === 0 && (String(row[aKey]).includes('å¯¹') || String(row[aKey]).includes('é”™'))) {
                options['A'] = 'æ­£ç¡®'; options['B'] = 'é”™è¯¯';
                if (String(row[aKey]).includes('å¯¹')) cleanAns = 'A';
                if (String(row[aKey]).includes('é”™')) cleanAns = 'B';
            }

            return {
                q: row[qKey],
                a: cleanAns,
                o: options,
                e: eKey ? row[eKey] : '',
                t: tKey ? row[tKey] : (cleanAns.length > 1 ? 'å¤šé€‰' : 'å•é€‰'),
                c: cKey ? row[cKey] : 'æœªåˆ†ç±»' // æ–°å¢ç±»åˆ«å­—æ®µ
            };
        }).filter(item => item !== null);
        return parsed;
    }

    function confirmImport() {
        const selectedSheets = Array.from(document.querySelectorAll('#sheet-selection-container input[name="sheet"]:checked'))
                                    .map(input => input.value);

        if (selectedSheets.length === 0) {
            alert('æ€»å¾—é€‰ä¸ªåœ°æ–¹æŒ–å§ï¼Ÿ');
            return;
        }

        const meta = getMeta();
        selectedSheets.forEach(sheetName => {
            const id = Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9);
            const data = tempImportData[sheetName];
            
            try {
                localStorage.setItem(`bingo_db_${id}`, JSON.stringify(data));
                meta.push({ id, name: sheetName, count: data.length, lastUsed: Date.now() });
            } catch (e) {
                alert('ç‹—çªæ»¡äº†ï¼å¿«ä¸¢æ‰ç‚¹æ—§éª¨å¤´ã€‚');
                return;
            }
        });

        saveMeta(meta);
        closeImportModal();
        renderDbList();
    }

    // --- ä»ªè¡¨ç›˜é€»è¾‘ ---
    function saveWipQuiz() {
        if (!currentDb || !currentQuiz.length) return;
        const wipState = {
            quizType: quizType,
            currentQuiz: currentQuiz,
            userAnswers: userAnswers
        };
        localStorage.setItem(`bingo_wip_${currentDb.id}`, JSON.stringify(wipState));
    }

    function clearWipQuiz() {
        if (currentDb) localStorage.removeItem(`bingo_wip_${currentDb.id}`);
    }

    function openDashboard(id) {
        const meta = getMeta().find(m => m.id === id);
        if (!meta) { console.error("DB meta not found for id:", id); goHome(); return; }
        
        const questions = JSON.parse(localStorage.getItem(`bingo_db_${id}`) || '[]');
        const progress = parseInt(localStorage.getItem(`bingo_prog_${id}`) || '0');
        currentDb = { ...meta, questions, progress };

        const wipData = localStorage.getItem(`bingo_wip_${id}`);
        if (wipData) {
            if (confirm('æ‚¨æœ‰ä¸€ä¸ªæœªå®Œæˆçš„ç»ƒä¹ ï¼Œè¦ç»§ç»­å—ï¼Ÿ\n(é€‰æ‹©â€œå–æ¶ˆâ€å°†ä¸¢å¼ƒè¯¥è¿›åº¦)')) {
                const wipState = JSON.parse(wipData);
                currentQuiz = wipState.currentQuiz;
                userAnswers = wipState.userAnswers;
                quizType = wipState.quizType;
                isReviewMode = false;
                
                document.getElementById('view-home').style.display = 'none';
                document.getElementById('view-dashboard').style.display = 'none';
                document.getElementById('view-quiz').style.display = 'block';
                document.getElementById('quiz-fab-area').style.display = 'flex';
                renderQuizItems();
                return;
            } else {
                localStorage.removeItem(`bingo_wip_${id}`);
            }
        }

        document.getElementById('view-home').style.display = 'none';
        document.getElementById('view-dashboard').style.display = 'block';
        
        // æ›´æ–°UI
        document.getElementById('dash-title').innerText = meta.name;
        document.getElementById('dash-count').innerText = questions.length;
        document.getElementById('dash-progress').innerText = `${progress} / ${questions.length}`;

        // æ›´æ–°å¹¶å¡«å……åˆ†ç±»ä¸‹æ‹‰èœå•
        const categoryContainer = document.getElementById('category-container');
        const categorySelect = document.getElementById('category-select');
        const categories = [...new Set(questions.map(q => q.c || 'æœªåˆ†ç±»'))];
        
        if (categories.length > 1 || (categories.length === 1 && categories[0] !== 'æœªåˆ†ç±»')) {
            categorySelect.innerHTML = '<option value="all">å…¨éƒ¨</option>';
            categories.forEach(c => {
                categorySelect.innerHTML += `<option value="${c}">${c}</option>`;
            });
            categoryContainer.style.display = 'block';
        } else {
            categoryContainer.style.display = 'none';
        }


        // æ›´æ–°æœ€è¿‘ä½¿ç”¨æ—¶é—´
        const allMeta = getMeta();
        const target = allMeta.find(m => m.id === id);
        if(target) {
            target.lastUsed = Date.now();
            saveMeta(allMeta);
        }

        renderHistoryList(id);
    }

    function goHome() {
        document.getElementById('view-dashboard').style.display = 'none';
        document.getElementById('view-home').style.display = 'block';
        renderDbList(); // åˆ·æ–°é¡ºåº
    }

    function deleteCurrentDb() {
        if(!confirm('çœŸè¦æŠŠè¿™çªéª¨å¤´éƒ½æ‰”äº†ï¼Ÿå†ä¹Ÿæ‰¾ä¸å›äº†å“¦ï¼')) return;
        
        const id = currentDb.id;
        localStorage.removeItem(`bingo_db_${id}`);
        localStorage.removeItem(`bingo_prog_${id}`);
        localStorage.removeItem(`bingo_hist_${id}`);
        localStorage.removeItem(`bingo_wip_${id}`); // Also clear WIP
        
        const meta = getMeta().filter(m => m.id !== id);
        saveMeta(meta);
        
        goHome();
    }

    function getAllWrongQuestions(dbId) {
        const history = JSON.parse(localStorage.getItem(`bingo_hist_${dbId}`) || '[]');
        const wrongQuestions = {}; // Use object to deduplicate based on question text

        history.forEach(record => {
            if (!record.quizSnapshot || !record.userAnswers) return;

            record.quizSnapshot.forEach((question, index) => {
                const userAnswer = record.userAnswers[index] || '';
                if (userAnswer !== question.a) {
                    // Use question content as key to avoid duplicates
                    wrongQuestions[question.q] = question;
                }
            });
        });

        return Object.values(wrongQuestions);
    }

    function startWrongAnswerQuiz() {
        const wrongQuestions = getAllWrongQuestions(currentDb.id);

        if (wrongQuestions.length === 0) {
            alert('å¤ªæ£’äº†ï¼Œæ²¡æœ‰å‘ç°é”™é¢˜ï¼ä½ å°±æ˜¯æœ€èªæ˜çš„æ–Œç‹—ï¼');
            return;
        }

        quizType = 'wrong_review'; // A new type for this mode
        isReviewMode = false;
        userAnswers = {};
        currentQuiz = wrongQuestions.sort(() => 0.5 - Math.random()); // Shuffle them

        document.getElementById('view-dashboard').style.display = 'none';
        document.getElementById('view-quiz').style.display = 'block';
        document.getElementById('quiz-fab-area').style.display = 'flex';
        
        renderQuizItems();
        saveWipQuiz();
    }

    // --- å†å²è®°å½• ---
    function renderHistoryList(dbId) {
        const list = JSON.parse(localStorage.getItem(`bingo_hist_${dbId}`) || '[]');
        const container = document.getElementById('history-list');
        container.innerHTML = '';

        if (list.length === 0) {
            document.getElementById('no-history-btn').style.display = 'block';
        } else {
            document.getElementById('no-history-btn').style.display = 'none';
            // å€’åºæ˜¾ç¤ºæœ€è¿‘10æ¡
            list.slice().reverse().slice(0, 10).forEach((item, index) => {
                const scoreClass = item.score >= 90 ? 'score-high' : (item.score < 60 ? 'score-low' : '');
                const el = document.createElement('div');
                el.className = 'history-item';
                el.innerHTML = `
                    <div>
                        <div style="font-weight:bold; font-size:14px;">${item.type === 'sequence' ? 'æŒ‰åºå¼€å•ƒ' : 'éšä¾¿åˆ¨ä¸€ä¸ª'}</div>
                        <div style="font-size:12px; color:var(--text-sub);">${new Date(item.date).toLocaleString()}</div>
                    </div>
                    <div class="score-badge ${scoreClass}">${item.score}</div>
                `;
                el.onclick = () => loadReview(list.length - 1 - index);
                container.appendChild(el);
            });
        }

        // æ›´æ–°é”™é¢˜æŒ‰é’®çŠ¶æ€
        const wrongQuestions = getAllWrongQuestions(dbId);
        const wrongAnswersBtn = document.getElementById('btn-wrong-answers');
        if (wrongQuestions.length > 0) {
            wrongAnswersBtn.style.display = 'block';
            wrongAnswersBtn.innerText = `å•ƒç¡¬éª¨å¤´ (${wrongQuestions.length} æ ¹)`;
        } else {
            wrongAnswersBtn.style.display = 'none';
        }
    }

    function saveHistory(score, type) {
        const id = currentDb.id;
        const list = JSON.parse(localStorage.getItem(`bingo_hist_${id}`) || '[]');
        list.push({
            date: Date.now(),
            score: score,
            type: type,
            quizSnapshot: currentQuiz, // ä¿å­˜å½“æ—¶çš„é¢˜ç›®å’Œç”¨æˆ·ç­”æ¡ˆ
            userAnswers: userAnswers
        });
        // é™åˆ¶åªå­˜æœ€è¿‘20æ¡ï¼Œé˜²æ­¢çˆ†ç‚¸
        if(list.length > 20) list.shift();
        localStorage.setItem(`bingo_hist_${id}`, JSON.stringify(list));
    }

    function loadReview(historyIndex) {
        const id = currentDb.id;
        const list = JSON.parse(localStorage.getItem(`bingo_hist_${id}`) || '[]');
        // æ³¨æ„ï¼šrenderHistoryListæ˜¯å€’åºæ˜¾ç¤ºçš„ï¼Œä½†è¿™é‡Œéœ€è¦ä¼ å…¥çœŸå®index
        // ä¸ºäº†ç®€å•ï¼Œä¸Šé¢çš„clickäº‹ä»¶ä¼ çš„æ˜¯å€’åºåçš„å¯¹åº”çœŸå®index
        
        const record = list[historyIndex];
        if(!record) return;

        currentQuiz = record.quizSnapshot;
        userAnswers = record.userAnswers;
        isReviewMode = true;

        document.getElementById('view-dashboard').style.display = 'none';
        document.getElementById('view-quiz').style.display = 'block';
        document.getElementById('quiz-fab-area').style.display = 'none'; // å›çœ‹ä¸èƒ½äº¤å·
        
        renderQuizItems();
    }

    // --- æ¨¡æ‹Ÿè€ƒè¯•é€»è¾‘ ---
    let quizTimer = null;
    let timeLeft = 0;

    function startTimer(duration) {
        stopTimer(); // Ensure no multiple timers
        timeLeft = duration;
        updateTimerDisplay();
        quizTimer = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            if (timeLeft <= 0) {
                stopTimer();
                alert('æ—¶é—´åˆ°ï¼Œè‡ªåŠ¨äº¤å·ï¼');
                submitPaper(true); // Pass a flag to bypass confirm
            }
        }, 1000);
    }

    function stopTimer() {
        clearInterval(quizTimer);
        quizTimer = null;
        document.getElementById('quiz-timer').innerText = '';
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        const timerEl = document.getElementById('quiz-timer');
        timerEl.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        // æ—¶é—´ç´§æ€¥æ—¶å˜è‰²
        if (timeLeft <= 30 && timeLeft > 10) {
            timerEl.style.color = 'var(--primary)';
        } else if (timeLeft <= 10) {
            timerEl.style.color = 'var(--danger)';
        } else {
            timerEl.style.color = 'var(--primary)';
        }
    }
    
    function startMockExam() {
        const count = parseInt(document.getElementById('mock-exam-count').value);
        // æ¯é¢˜90ç§’
        const totalTime = count * 90; 

        const selectedCategory = document.getElementById('category-select')?.value;
        let questionsForQuiz = currentDb.questions;

        if (selectedCategory && selectedCategory !== 'all') {
            questionsForQuiz = currentDb.questions.filter(q => (q.c || 'æœªåˆ†ç±»') === selectedCategory);
        }

        const shuffled = [...questionsForQuiz].sort(() => 0.5 - Math.random());
        currentQuiz = shuffled.slice(0, count);

        if (currentQuiz.length === 0) {
            return alert('è¿™ä¸ªåˆ†ç±»ä¸‹æ²¡æœ‰è¶³å¤Ÿçš„éª¨å¤´è¿›è¡Œæ¨¡æ‹Ÿï¼');
        }

        quizType = 'mock_exam';
        isReviewMode = false;
        userAnswers = {};

        document.getElementById('view-dashboard').style.display = 'none';
        document.getElementById('view-quiz').style.display = 'block';
        document.getElementById('quiz-fab-area').style.display = 'flex';
        
        renderQuizItems();
        // æ¨¡æ‹Ÿè€ƒè¯•ä¸ä¿å­˜WIPï¼Œå¢åŠ æŒ‘æˆ˜æ€§
        clearWipQuiz();

        startTimer(totalTime);
    }

    // --- ç­”é¢˜é€»è¾‘ ---
    let quizType = 'random'; 

    function startQuiz(type) {
        quizType = type;
        isReviewMode = false;
        userAnswers = {};

        const selectedCategory = document.getElementById('category-select')?.value;
        let questionsForQuiz = currentDb.questions;

        if (selectedCategory && selectedCategory !== 'all') {
            questionsForQuiz = currentDb.questions.filter(q => (q.c || 'æœªåˆ†ç±»') === selectedCategory);
        }
        
        if (type === 'random') {
            const countValue = document.getElementById('random-count').value;
            const count = countValue === 'all' ? questionsForQuiz.length : parseInt(countValue);
            const shuffled = [...questionsForQuiz].sort(() => 0.5 - Math.random());
            currentQuiz = shuffled.slice(0, count);
        } else {
            // é¡ºåº
            const countValue = document.getElementById('sequence-count').value;
            const count = countValue === 'all' ? questionsForQuiz.length : parseInt(countValue);
            
            // æ³¨æ„ï¼šé¡ºåºæ¨¡å¼ä¸‹çš„è¿›åº¦æ˜¯åŸºäºå®Œæ•´é¢˜åº“çš„ï¼Œåˆ†ç±»ç»ƒä¹ æ—¶ï¼Œè¿™ä¸ªè¿›åº¦å¯èƒ½ä¸å¤ªé€‚ç”¨
            // ç®€åŒ–å¤„ç†ï¼šé¡ºåºåˆ†ç±»ç»ƒä¹ ä¹Ÿä»0å¼€å§‹
            const start = (selectedCategory && selectedCategory !== 'all') ? 0 : currentDb.progress;
            
            if (countValue === 'all') {
                currentQuiz = questionsForQuiz.slice(start);
            } else {
                currentQuiz = questionsForQuiz.slice(start, start + count);
            }

            if (currentQuiz.length === 0) return alert('æ–Œç‹—ï¼è¿™å †éª¨å¤´å•ƒå®Œäº†ï¼');
        }

        document.getElementById('view-dashboard').style.display = 'none';
        document.getElementById('view-quiz').style.display = 'block';
        document.getElementById('quiz-fab-area').style.display = 'flex';
        
        renderQuizItems();
        saveWipQuiz();
    }

    function renderQuizItems() {
        const container = document.getElementById('quiz-container');
        container.innerHTML = '';
        const bodyClass = isReviewMode ? 'review-mode' : '';
        container.className = bodyClass;

        document.getElementById('quiz-progress-text').innerText = `æœ¬è½® ${currentQuiz.length} æ ¹éª¨å¤´`;

        currentQuiz.forEach((item, idx) => {
            const uAns = userAnswers[idx] || '';
            let cardClass = 'ios-card';
            let analysisHtml = '';

            // å›çœ‹æ¨¡å¼ä¸‹ï¼Œæ ‡è®°å¯¹é”™å¹¶æ˜¾ç¤ºè§£æ
            if (isReviewMode) {
                const isCorrect = uAns === item.a;
                cardClass += isCorrect ? ' correct' : ' wrong';
                analysisHtml = `
                    <div style="margin-top:15px; padding:10px; background:var(--bg-input); border-radius:8px; font-size:14px;">
                        <div style="font-weight:bold; margin-bottom:4px;">
                            æ±ªçš„ç­”æ¡ˆï¼š<span style="color:var(--success)">${item.a}</span>
                            ${!isCorrect ? `<span style="margin-left:10px; color:var(--danger)">ä½ åˆ¨çš„ï¼š${uAns || 'æœªé€‰'}</span>` : ''}
                        </div>
                        <div style="color:var(--text-sub);">${item.e || 'åªèƒ½æ„ä¼š'}</div>
                    </div>
                `;
            }

            // æ¸²æŸ“é€‰é¡¹
            let optionsHtml = '';
            for (let key in item.o) {
                const isSelected = uAns.includes(key) ? 'selected' : '';
                // å›çœ‹æ¨¡å¼ä¸‹ï¼Œé«˜äº®æ­£ç¡®ç­”æ¡ˆï¼ˆå³ä½¿ç”¨æˆ·æ²¡é€‰ï¼‰
                const isRealAnswer = isReviewMode && item.a.includes(key) ? 'correct-answer' : '';
                
                optionsHtml += `
                    <div class="option-row ${isSelected} ${isRealAnswer}" onclick="selectOption(${idx}, '${key}', '${item.t}')">
                        <div class="option-circle">${key}</div>
                        <div style="flex:1">${item.o[key]}</div>
                    </div>
                `;
            }

            const html = `
                <div class="${cardClass}" id="q-${idx}">
                    <div style="margin-bottom:10px;">
                        <span class="bingo-badge" style="margin-left:0; margin-right:5px;">${item.t || 'å•é€‰'}</span>
                        <span style="font-weight:600; font-size:17px; line-height:1.4;">${idx+1}. ${item.q}</span>
                    </div>
                    <div>${optionsHtml}</div>
                    ${analysisHtml}
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    function selectOption(qIdx, optKey, type) {
        if (isReviewMode) return; // å›çœ‹ä¸å¯é€‰

        const isMulti = type.includes('å¤š');
        let current = userAnswers[qIdx] || '';

        if (!isMulti) {
            current = optKey;
        } else {
            // å¤šé€‰é€»è¾‘
            if (current.includes(optKey)) {
                current = current.replace(optKey, '');
            } else {
                current += optKey;
            }
            current = current.split('').sort().join('');
        }

        userAnswers[qIdx] = current;
        saveWipQuiz();
        
        // æ›´æ–°UIé€‰ä¸­çŠ¶æ€
        const card = document.getElementById(`q-${qIdx}`);
        const rows = card.querySelectorAll('.option-row');
        rows.forEach(row => {
            const k = row.querySelector('.option-circle').innerText;
            if (isMulti) {
                if (current.includes(k)) row.classList.add('selected');
                else row.classList.remove('selected');
            } else {
                if (k === current) row.classList.add('selected');
                else row.classList.remove('selected');
            }
        });
    }

    function submitPaper(autoSubmit = false) {
        if (!autoSubmit && !confirm('ä¸æ”¹äº†ï¼ŸçœŸçš„äº¤å·äº†å“¦ï¼Ÿ')) return;
        
        stopTimer();
        
        let correctCount = 0;
        currentQuiz.forEach((q, i) => {
            if ((userAnswers[i] || '') === q.a) correctCount++;
        });

        const score = Math.round((correctCount / currentQuiz.length) * 100);
        
        // "é”™é¢˜å›é¡¾"æˆ–â€œæ¨¡æ‹Ÿè€ƒè¯•â€æ¨¡å¼ä¸ä¿å­˜è¿›åº¦å’Œå†å²
        if (quizType !== 'wrong_review' && quizType !== 'mock_exam') {
            // æ›´æ–°è¿›åº¦ (ä»…é¡ºåºæ¨¡å¼)
            if (quizType === 'sequence') {
                const newProg = currentDb.progress + currentQuiz.length;
                localStorage.setItem(`bingo_prog_${currentDb.id}`, newProg);
            }

            // ä¿å­˜å†å²
            saveHistory(score, quizType);
        }

        clearWipQuiz();

        // æ˜¾ç¤ºå¼¹çª—
        document.getElementById('result-score').innerText = score;
        document.getElementById('modal-score').style.display = 'flex';
    }

    function enterReviewMode() {
        document.getElementById('modal-score').style.display = 'none';
        document.getElementById('quiz-fab-area').style.display = 'none';
        isReviewMode = true;
        renderQuizItems(); // é‡ç»˜å¸¦è§£æçš„ç•Œé¢
        window.scrollTo(0,0);
    }

    function exitQuiz() {
        stopTimer();
        document.getElementById('modal-score').style.display = 'none';
        document.getElementById('view-quiz').style.display = 'none';
        document.getElementById('view-dashboard').style.display = 'block';
        
        // åˆ·æ–° Dashboard æ•°æ® (å› ä¸ºè¿›åº¦å¯èƒ½å˜äº†)
        openDashboard(currentDb.id);
    }

</script>
<script src="xlsx.full.min.js"></script>
</body>
</html>
