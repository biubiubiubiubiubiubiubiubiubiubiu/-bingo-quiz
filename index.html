<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#F0F4F0" id="theme-color-meta">
    <title>æ–Œç‹—ï¼é€šå…³ï¼</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">

    <!-- å¼•å…¥ SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* --- æ ·å¼å®šä¹‰ --- */
        :root {
            --primary: #4A7856;
            --primary-light: rgba(74, 120, 86, 0.15);
            --success: #5A946E;
            --success-light: rgba(90, 148, 110, 0.15);
            --danger: #A95C52;
            --danger-light: rgba(169, 92, 82, 0.15);
            --bg-body: #F0F4F0;
            --bg-card: #F8F9F7;
            --bg-input: #E6EAE6;
            --text-main: #3A4D39;
            --text-sub: #6A7B69;
            --text-inverse: #FFFFFF;
            --shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            --radius-l: 20px;
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        [data-theme="everforest"] {
            --primary: #7FBBB3;
            --primary-light: rgba(127, 187, 179, 0.15);
            --success: #A7C080;
            --success-light: rgba(167, 192, 128, 0.15);
            --danger: #E67E80;
            --danger-light: rgba(230, 126, 128, 0.15);
            --bg-body: #272E33;
            --bg-card: #2E383C;
            --bg-input: #374145;
            --text-main: #D3C6AA;
            --text-sub: #9DA9A0;
            --text-inverse: #272E33;
            --shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        html {
            overscroll-behavior-x: contain;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background: var(--bg-body);
            color: var(--text-main);
            padding-bottom: calc(80px + var(--safe-area-bottom));
            transition: background 0.3s;
            touch-action: pan-y;
            overscroll-behavior-x: contain;
        }

        .container {
            padding: 0 20px;
        }

        /* å¯¼èˆªæ  */
        .nav-bar {
            padding: 40px 20px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-body);
            position: sticky;
            top: 0;
            z-index: 90;
        }

        .nav-title {
            font-size: 28px;
            font-weight: 800;
        }

        .bingo-badge {
            background: linear-gradient(135deg, var(--primary), var(--success));
            color: #fff;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 14px;
            margin-left: 8px;
            vertical-align: middle;
        }

        /* å¡ç‰‡é€šç”¨ */
        .ios-card {
            background: var(--bg-card);
            border-radius: var(--radius-l);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            position: relative;
            transition: 0.2s;
        }

        .ios-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(58, 77, 57, 0.08);
        }

        /* ç»Ÿä¸€é«˜åº¦ */
        .btn,
        .input-ghost,
        select.btn-ghost {
            height: 52px;
            line-height: normal;
            box-sizing: border-box;
        }

        /* æŒ‰é’® */
        .btn {
            width: 100%;
            padding: 0 15px;
            border: none;
            border-radius: 16px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        /* å…³é”®ä¿®å¤ï¼šè¾“å…¥æ¡†æ ·å¼ & éšè—å¾®è°ƒç®­å¤´ */
        .input-ghost {
            background: var(--bg-input);
            color: var(--primary);
            border: 2px solid transparent;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 800;
            text-align: center;
            transition: 0.2s;
            width: 100%;
            padding: 0;
            -moz-appearance: textfield;
            /* Firefox éšè—ç®­å¤´ */
        }

        /* Chrome, Safari, Edge, Opera éšè—ç®­å¤´ */
        .input-ghost::-webkit-outer-spin-button,
        .input-ghost::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .input-ghost:focus {
            background: var(--bg-card);
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-light);
        }

        /* å…³é”®ä¿®å¤ï¼šä¸‹æ‹‰æ¡†æ ·å¼ & éšè—é»˜è®¤ç®­å¤´ */
        select.btn-ghost {
            appearance: none;
            /* æ ‡å‡† */
            -webkit-appearance: none;
            /* Safari/Chrome å¿…é¡» */
            -moz-appearance: none;
            /* Firefox */
            background-color: var(--bg-input);
            padding-right: 35px !important;
            /* ç»™è‡ªå®šä¹‰ç®­å¤´ç•™ä½ç½® */
            padding-left: 15px;
            /* å·¦ä¾§ç•™ç™½ */
            text-align: center;
            /* æ–‡å­—å±…ä¸­ */
            text-align-last: center;
            /* å¼ºåˆ¶éƒ¨åˆ†æµè§ˆå™¨å±…ä¸­ */
            border-radius: 16px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            width: 100%;

            /* è‡ªå®šä¹‰ç®­å¤´å›¾æ ‡ SVG */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%238E8E93%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 12px center;
            /* è°ƒæ•´ç®­å¤´ä½ç½® */
            background-size: 10px;
        }

        /* æš—è‰²æ¨¡å¼ä¸‹ç®­å¤´é¢œè‰²è°ƒæ•´ */
        [data-theme="everforest"] select.btn-ghost {
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%239DA9A0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger-light);
            color: var(--danger);
        }

        .btn-ghost {
            background: var(--bg-input);
            color: var(--text-sub);
        }

        .btn-float {
            position: fixed;
            bottom: 40px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            font-size: 30px;
            box-shadow: 0 8px 20px rgba(74, 120, 86, 0.4);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* åˆ—è¡¨ */
        .db-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border: none;
        }

        .db-info h4 {
            margin: 0 0 8px 0;
            font-size: 18px;
            font-weight: 600;
        }

        .db-info p {
            margin: 0;
            font-size: 14px;
            color: var(--text-sub);
        }

        /* å†å²è®°å½•é¡¹ */
        .history-item {
            background: var(--bg-input);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .score-badge {
            font-weight: 800;
            font-size: 20px;
        }

        .score-high {
            color: var(--success);
        }

        .score-low {
            color: var(--danger);
        }

        /* ç­”é¢˜åŒº */
        .option-row {
            padding: 15px;
            background: var(--bg-input);
            border-radius: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: 0.2s;
        }

        .option-row.selected {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .option-circle {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 2px solid var(--text-sub);
            margin-right: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .selected .option-circle {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* é”™é¢˜/å›çœ‹æ ·å¼ */
        .ios-card.correct {
            border: 2px solid var(--success);
        }

        .ios-card.wrong {
            border: 2px solid var(--danger);
        }

        .review-mode .selected .option-circle {
            color: white;
        }

        .review-mode .ios-card.correct .selected .option-circle {
            background: var(--success);
            border-color: var(--success);
        }

        .review-mode .ios-card.wrong .selected .option-circle {
            background: var(--danger);
            border-color: var(--danger);
        }

        .review-mode .option-row.correct-answer {
            background: var(--success-light);
            border: 2px dashed var(--success);
        }

        /* Modal */
        .modal-mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: var(--bg-card);
            width: 90%;
            max-width: 350px;
            border-radius: 25px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: popIn 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        @keyframes popIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Loading */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-body);
            z-index: 999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            display: none;
        }

        .spinner {
            width: 45px;
            height: 45px;
            border: 5px solid var(--primary-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #sheet-selection-container label {
            display: block;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
        }

        #sheet-selection-container label:hover {
            background: var(--bg-input);
        }

        #sheet-selection-container input {
            margin-right: 10px;
        }

        .btn-primary:hover,
        .btn-success:hover {
            filter: brightness(1.1);
        }

        .btn-ghost:not(select):hover {
            background: var(--bg-card);
        }

        .nav-bar .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
        }

        .nav-bar .btn-icon svg {
            width: 20px;
            height: 20px;
        }

        .nav-bar .btn-icon.btn-delete {
            color: var(--danger);
        }

        .nav-bar .btn-icon.btn-delete:hover {
            background: var(--danger-light);
        }

        .btn-mastered {
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 500;
            border-radius: 8px;
            background: var(--success-light);
            color: var(--success);
            border: none;
            cursor: pointer;
            flex-shrink: 0;
        }

        .btn-mastered:hover {
            filter: brightness(1.1);
        }

        .btn-delete-hist {
            background: var(--danger-light);
            color: var(--danger);
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            line-height: 28px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            margin-left: 15px;
            flex-shrink: 0;
        }

        .btn-delete-hist:hover {
            filter: brightness(1.05);
        }

        #view-quiz .nav-bar {
            background: rgba(242, 242, 247, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--bg-input);
            padding: 10px 20px;
            padding-top: calc(10px + env(safe-area-inset-top));
        }

        [data-theme="everforest"] #view-quiz .nav-bar {
            background: rgba(46, 56, 60, 0.7);
        }

        /* å·å·çœ‹ä¸€çœ¼æŒ‰é’® */
        .btn-peek {
            background: transparent;
            border: 1px dashed var(--text-sub);
            color: var(--text-sub);
            padding: 4px 10px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-peek:hover {
            background: var(--bg-input);
            border-style: solid;
        }

        /* å·å·çœ‹ä¸€çœ¼çš„ç­”æ¡ˆåŒºåŸŸ */
        .analysis-box {
            margin-top: 15px;
            padding: 12px;
            background: var(--primary-light);
            border-radius: 12px;
            font-size: 14px;
            border: 1px solid var(--primary);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (min-width: 600px) {
            .container {
                max-width: 800px;
                margin: 0 auto;
            }

            .modal-box {
                max-width: 400px;
            }
        }

        /* --- å„¿ç«¥æ¨¡å¼æ ·å¼ --- */
        [data-mode="child"] {
            --primary: #FF9F1C;
            /* æ´»åŠ›æ©™ */
            --primary-light: #FFF0D4;
            --success: #2EC4B6;
            /* ç³–æœç»¿ */
            --danger: #FF3366;
            /* ç³–æœçº¢ */
            --bg-body: #FFFCF2;
            /* å¥¶æ²¹ç™½ */
            --bg-card: #FFFFFF;
            --bg-input: #F0F4F8;
            --text-main: #2B2D42;
            --text-sub: #8D99AE;
            --radius-l: 30px;
            /* æ›´åœ†æ¶¦ */
            font-family: "YouYuan", "Chalkboard SE", "Comic Sans MS", sans-serif;
            /* å¡é€šå­—ä½“ */
        }

        /* å„¿ç«¥æ¨¡å¼ä¸‹éšè—å¤æ‚çš„æŒ‰é’®å’Œç»Ÿè®¡ */
        [data-mode="child"] .btn-delete,
        [data-mode="child"] .btn-delete-hist,
        [data-mode="child"] #btn-wrong-answers,
        [data-mode="child"] #btn-resume-quiz,
        [data-mode="child"] .nav-bar .btn-icon:not(.btn-child-toggle):not(.btn-quiz-exit),
        [data-mode="child"] #history-list,
        [data-mode="child"] #import-export-area,
        [data-mode="child"] .btn-float {
            display: none !important;
        }

        /* å„¿ç«¥æ¨¡å¼ç‰¹æœ‰çš„å¤§æŒ‰é’® */
        [data-mode="child"] .option-row {
            padding: 20px;
            margin-bottom: 15px;
            background: white;
            border: 3px solid #F0F4F8;
            transition: transform 0.1s;
        }

        [data-mode="child"] .option-row:active {
            transform: scale(0.95);
        }

        [data-mode="child"] .option-circle {
            width: 40px;
            height: 40px;
            font-size: 20px;
            border-width: 3px;
        }

        /* ç­”å¯¹åŠ¨ç”» */
        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }

            50% {
                transform: scale(1.05);
            }

            70% {
                transform: scale(0.9);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .child-feedback-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }

        .child-star {
            font-size: 100px;
            animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* æ‘‡æ™ƒåŠ¨ç”»ï¼ˆç­”é”™ï¼‰ */
        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }

        .shake-it {
            animation: shake 0.4s;
            border-color: var(--danger) !important;
            color: var(--danger);
        }

        /* è¯­éŸ³æŒ‰é’® */
        .btn-tts {
            display: none;
            /* é»˜è®¤éšè— */
            background: #E0F7FA;
            color: #00BCD4;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            flex-shrink: 0;
        }

        [data-mode="child"] .btn-tts {
            display: flex;
        }
    </style>
</head>

<body>

    <!-- Loading -->
    <div class="loader-overlay" id="global-loader">
        <div class="spinner"></div>
        <p style="color:var(--text-sub); margin-top:10px;" id="loader-text">çŒ›çŠ¬æŒ–æ˜ä¸­...</p>
    </div>

    <!-- VIEW 1: é¢˜åº“åˆ—è¡¨é¦–é¡µ -->
    <div id="view-home" class="container" style="padding: 0 20px;">
        <div class="nav-bar" style="padding-left:0; padding-right:0;">
            <div>
                <div class="nav-title">æˆ‘çš„ç‹—çª <span class="bingo-badge">Pro</span></div>
                <div style="font-size:13px; color:var(--text-sub);">ç¦»çº¿å¯ç”¨ Â· æ— é™ç‹—çª Â· éšæ—¶å¤ç›˜</div>
            </div>
            <div style="display:flex; gap:10px;">
                <!-- åœ¨ view-home çš„ nav-bar divé‡Œ -->
                <button class="btn btn-ghost btn-icon btn-child-toggle" onclick="toggleChildMode()" title="åˆ‡æ¢å„¿ç«¥æ¨¡å¼"
                    style="color: #FF9F1C;">
                    <span id="child-icon">ğŸ‘¶</span>
                </button>
                <button class="btn btn-ghost btn-icon" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
                <button class="btn btn-ghost btn-icon btn-delete" onclick="deleteAllData()" title="åˆ é™¤æ‰€æœ‰æ•°æ®">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
                <button id="btn-install-pwa" class="btn btn-ghost btn-icon" style="display: none;" title="å®‰è£…åº”ç”¨">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="8 17 12 21 16 17"></polyline>
                        <line x1="12" y1="12" x2="12" y2="21"></line>
                        <path d="M20.88 18.09A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.29"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div id="db-list-container"></div>

        <div class="ios-card" id="empty-state"
            style="text-align:center; padding:40px 20px; display:none; cursor: pointer;" onclick="showImportModal()">
            <div style="font-size:40px; margin-bottom:10px;">ğŸ¦´</div>
            <h3 style="margin:0;">ç‹—çªç©ºç©ºå¦‚ä¹Ÿ</h3>
            <p style="color:var(--text-sub);">å¿«å»æŒ–ç‚¹æ–°éª¨å¤´ (+)ï¼Œæ”¯æŒè¡¨æ ¼æ–‡ä»¶</p>
        </div>

        <div class="btn-float" onclick="showImportModal()">+</div>
    </div>

    <!-- VIEW 2: å•ä¸ªé¢˜åº“ä»ªè¡¨ç›˜ -->
    <div id="view-dashboard" class="container" style="padding: 0 20px; display:none;">
        <div class="nav-bar" style="padding-left:0; padding-right:0;">
            <button class="btn btn-ghost btn-icon" onclick="history.back()" title="è¿”å›">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
            <div style="font-weight:bold; font-size:16px; max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                id="dash-title">ç‹—çªè¯¦æƒ…</div>
            <button class="btn btn-ghost btn-icon btn-delete" onclick="deleteCurrentDb()" title="åˆ é™¤é¢˜åº“">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
            </button>
        </div>

        <div class="ios-card">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <div>
                    <h2 style="margin:0; font-size:28px;" id="dash-count">0</h2>
                    <div style="font-size:12px; color:var(--text-sub);">éª¨å¤´æ€»æ•°</div>
                </div>
                <div style="text-align:right;">
                    <h2 style="margin:0; font-size:28px; color:var(--success);" id="dash-progress">0</h2>
                    <div style="font-size:12px; color:var(--text-sub);">å•ƒéª¨å¤´è¿›åº¦</div>
                </div>
            </div>

            <div id="category-container"
                style="margin-bottom: 20px; border-top: 1px solid var(--bg-input); padding-top: 15px;">
                <label for="category-select"
                    style="font-weight: bold; font-size: 14px; color: var(--text-sub); margin-bottom: 8px; display: block;">é€‰æ‹©åˆ†ç±»</label>
                <select id="category-select" class="btn btn-ghost"
                    style="width:100%; -webkit-appearance: none; appearance: none; text-align: left;"></select>
            </div>

            <button id="btn-resume-quiz" class="btn"
                style="display:none; margin-bottom: 20px; background: linear-gradient(135deg, var(--primary), var(--success)); color: white;"
                onclick="resumeQuiz()">ç»§ç»­ä¸Šæ¬¡çš„è¿›åº¦</button>

            <!-- æŒ‰é¡ºåºå•ƒåŒºåŸŸä¼˜åŒ– -->
            <div style="margin-bottom: 10px;">
                <div
                    style="font-size:12px; color:var(--text-sub); margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                    <span>ğŸ“ èµ·å§‹åºå·</span>
                    <span id="max-count-hint" style="background:var(--bg-input); padding:2px 6px; border-radius:4px;">å…±
                        0 æ ¹</span>
                </div>

                <!-- ä¿®å¤åçš„å¸ƒå±€ -->
                <div style="display:flex; gap:12px; align-items: stretch; height: 52px;">
                    <!-- è¾“å…¥æ¡†ï¼šå»é™¤äº† Spinner -->
                    <div style="flex-shrink: 0; width: 80px;">
                        <input type="number" id="sequence-start-input" class="input-ghost" onclick="this.select()">
                    </div>

                    <!-- æŒ‰é’® -->
                    <button class="btn btn-primary" style="flex-grow: 1;" onclick="startQuiz('sequence')">æŒ‰é¡ºåºå•ƒ</button>

                    <!-- ä¸‹æ‹‰æ¡†ï¼šåŠ å®½å®½åº¦ï¼Œä¿®å¤ç®­å¤´ -->
                    <div style="flex-shrink: 0; width: 100px;">
                        <select id="sequence-count" class="btn btn-ghost">
                            <option value="10">10æ ¹</option>
                            <option value="20">20æ ¹</option>
                            <option value="50" selected>50æ ¹</option>
                            <option value="100">100æ ¹</option>
                            <option value="all">æ¢­å“ˆ</option>
                        </select>
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn btn-success" style="flex-grow: 1;" onclick="startQuiz('random')">éšä¾¿åˆ¨ä¸€ä¸ª</button>
                <select id="random-count" class="btn btn-ghost"
                    style="max-width: 100px; padding: 0 15px; -webkit-appearance: none; appearance: none; background-image: none;">
                    <option value="10">10æ ¹</option>
                    <option value="20" selected>20æ ¹</option>
                    <option value="50">50æ ¹</option>
                    <option value="100">100æ ¹</option>
                    <option value="all">æ¢­å“ˆ</option>
                </select>
            </div>
            <div style="margin-top: 15px;">
                <button id="btn-wrong-answers" class="btn btn-danger" onclick="startWrongAnswerQuiz()">å•ƒç¡¬éª¨å¤´</button>
            </div>

            <div
                style="margin-top: 20px; border-top: 1px solid var(--bg-input); padding-top: 15px; display:flex; gap:10px;">
                <button class="btn btn-primary"
                    style="background: linear-gradient(135deg, #D9A869, #C18842); flex-grow: 1;"
                    onclick="startMockExam()">æ¨¡æ‹Ÿå¼€å•ƒ</button>
                <select id="mock-exam-count" class="btn btn-ghost"
                    style="max-width: 100px; padding: 0 15px; -webkit-appearance: none; appearance: none; background-image: none;">
                    <option value="10">10æ ¹</option>
                    <option value="20">20æ ¹</option>
                    <option value="50" selected>50æ ¹</option>
                    <option value="100">100æ ¹</option>
                </select>
            </div>
        </div>

        <div class="ios-card">
            <h4 style="margin:0 0 15px 0;">ğŸ“œ å•ƒéª¨å¤´çš„è®°å¿† (ç‚¹å‡»å›çœ‹)</h4>
            <div id="history-list"></div>
            <button class="btn btn-ghost" id="no-history-btn" style="display:none;">è¿˜æ²¡å•ƒè¿‡å‘¢</button>
        </div>
    </div>

    <!-- VIEW 3: ç­”é¢˜/å›çœ‹ç•Œé¢ -->
    <div id="view-quiz" style="display:none;">
        <div class="nav-bar">
            <div style="font-size:14px; font-weight:bold; color:var(--text-sub);" id="quiz-progress-text">1/20</div>
            <div style="font-size:16px; font-weight:bold; color:var(--primary);" id="quiz-timer"></div>
            <button class="btn btn-ghost btn-icon btn-quiz-exit" onclick="handleQuizExit()" title="é€€å‡º">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <div class="container" style="padding: 0 16px 100px 16px;">
            <div id="quiz-container"></div>
        </div>

        <!-- æäº¤æŒ‰é’®åŒº -->
        <div id="quiz-fab-area"
            style="position:fixed; bottom:0; left:0; width:100%; padding:20px; background:var(--bg-body); border-top:1px solid var(--bg-input); display:flex; gap:10px;">
            <button class="btn btn-success" onclick="submitPaper()">æ±ªï¼äº¤å·ï¼</button>
        </div>
    </div>

    <!-- Modal: å¯¼å…¥ -->
    <div class="modal-mask" id="modal-import">
        <div class="modal-box">
            <h3 style="margin-top:0;">æŒ–æ˜æ–°å®è—</h3>
            <p style="font-size:13px; color:var(--text-sub);">å®è—åœ°å›¾ (.xlsx/.xls) æŒ‡å—ï¼š<br>å¿…é¡»æ ‡æ˜ "é¢˜ç›®"ã€"ç­”æ¡ˆ" ç­‰...</p>

            <div id="import-feedback" style="margin-top:15px; display:none;">
                <div id="import-loader" class="spinner"
                    style="display:none; margin: 0 auto 10px auto; width:25px; height:25px; border-width: 3px;"></div>
                <p id="import-status" style="font-size:13px; color:var(--danger); text-align:center; margin:0;"></p>
            </div>

            <input type="file" id="file-input" accept=".xlsx, .xls" style="display:none"
                onchange="handleFileSelect(this)">

            <button class="btn btn-primary" id="btn-select-file"
                onclick="document.getElementById('file-input').click()">ğŸ“‚ é€‰æ‹©è—å®å›¾</button>

            <div id="import-preview" style="display:none; margin-top:15px;">
                <div id="sheet-selection-container"></div>
                <div style="font-size:12px; color:var(--success);">å‘ç°å®è—ï¼</div>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-ghost" onclick="closeImportModal()">æºœäº†æºœäº†</button>
                <button class="btn btn-primary" id="btn-confirm-import" style="display:none;"
                    onclick="confirmImport()">åŸ‹è¿›ç‹—çª</button>
            </div>
        </div>
    </div>

    <!-- Modal: æˆç»©å• -->
    <div class="modal-mask" id="modal-score">
        <div class="modal-box" style="text-align:center;">
            <h2 style="margin:10px 0;">å•ƒå®Œå•¦ï¼</h2>
            <div style="font-size:48px; font-weight:800; color:var(--primary);" id="result-score">90</div>
            <p style="color:var(--text-sub);">æ™ºåŠ›å€¼</p>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-ghost" onclick="finishExamAndExit()">å›ç‹—çª</button>
                <button class="btn btn-primary" onclick="enterReviewMode()">å›å‘³ä¸€ä¸‹</button>
            </div>
        </div>
    </div>

    <script>
        // --- PWA Service Worker æ³¨å†Œ ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(reg => {
                    console.log('SW registered:', reg);
                }).catch(err => console.log('SW failed:', err));
            });
        }

        let currentDb = null; // { id, name, questions, progress }
        let currentQuiz = []; // å½“å‰æ­£åœ¨åšçš„é¢˜
        let userAnswers = {}; // ç”¨æˆ·å½“å‰é€‰æ‹©
        let isReviewMode = false; // æ˜¯å¦å¤„äºå›çœ‹æ¨¡å¼
        let lastCompletedQuiz = []; // ç”¨äºäº¤å·åå›çœ‹
        let lastCompletedAnswers = {}; // ç”¨äºäº¤å·åå›çœ‹
        let lastVisibleQuestionIndex = 0;
        let masteredInSession = 0; // ç”¨äºâ€œå•ƒç¡¬éª¨å¤´â€æ¨¡å¼çš„è®¡æ•°
        let deferredInstallPrompt = null;
        let quizType = 'random';

        // --- Navigation & History ---
        function updateView(state) {
            document.getElementById('view-home').style.display = 'none';
            document.getElementById('view-dashboard').style.display = 'none';
            document.getElementById('view-quiz').style.display = 'none';
            document.getElementById('modal-score').style.display = 'none';
            stopTimer();

            if (!state || !state.view) {
                state = { view: 'home' };
            }

            switch (state.view) {
                case 'dashboard':
                    document.getElementById('view-dashboard').style.display = 'block';
                    setupDashboard(state.dbId);
                    break;
                case 'quiz':
                    document.getElementById('view-quiz').style.display = 'block';
                    break;
                default: // home
                    document.getElementById('view-home').style.display = 'block';
                    renderDbList();
                    break;
            }
        }

        // --- Navigation & History (æ ¸å¿ƒä¿®æ”¹ç‰ˆ) ---
        window.onpopstate = function (event) {
            // ã€æ ¸å¿ƒæ‹¦æˆªé€»è¾‘ã€‘
            // å¦‚æœå½“å‰å¤„äºâ€œæ¨¡æ‹Ÿè€ƒè¯•â€ä¸”â€œéå›çœ‹â€çŠ¶æ€
            if (quizType === 'mock_exam' && !isReviewMode) {
                // å¼¹å‡ºç³»ç»Ÿçº§ç¡®è®¤æ¡†ï¼ˆè¿™ä¼šæš‚åœ JS æ‰§è¡Œï¼‰
                const confirmExit = confirm('âš ï¸ æ­£åœ¨æ¨¡æ‹Ÿè€ƒè¯•ä¸­ï¼\n\nç³»ç»Ÿæ£€æµ‹åˆ°è¿”å›æ“ä½œï¼ˆæˆ–ä¾§æ»‘ï¼‰ã€‚\nç°åœ¨é€€å‡ºå°†å¼ºåˆ¶äº¤å·ã€‚\n\nç¡®å®šè¦äº¤å·å—ï¼Ÿ');

                if (confirmExit) {
                    // ç”¨æˆ·ç‚¹â€œç¡®å®šâ€ï¼šè™½ç„¶æµè§ˆå™¨URLå·²ç»å˜äº†ï¼Œä½†æˆ‘ä»¬æ‰‹åŠ¨æ‰§è¡Œäº¤å·æµç¨‹
                    // true ä»£è¡¨è‡ªåŠ¨äº¤å·ï¼Œä¸å†é‡å¤å¼¹çª—
                    submitPaper(true);

                    // æ³¨æ„ï¼šæ­¤æ—¶ URL å¯èƒ½å·²ç»å˜å›äº† dashboardï¼Œä½†ç•Œé¢è¢« submitPaper ç•™åœ¨äº† quiz
                    // è¿™å¯¹äº SPA æ˜¯å…è®¸çš„ï¼Œç­‰ç”¨æˆ·åœ¨æˆç»©å•ç‚¹å‡»â€œå›ç‹—çªâ€æ—¶ä¼šä¿®æ­£
                    return;
                } else {
                    // ç”¨æˆ·ç‚¹â€œå–æ¶ˆâ€ï¼ˆæˆ‘æƒ³ç•™ä¸‹ï¼‰ï¼š
                    // å…³é”®æ“ä½œï¼å› ä¸ºåˆšæ‰çš„ä¾§æ»‘å·²ç»è®©æµè§ˆå™¨åé€€äº†ä¸€æ­¥
                    // æˆ‘ä»¬å¿…é¡»ç«‹åˆ»æŠŠè¿™ä¸ªçŠ¶æ€â€œæ¨â€å›å»ï¼Œæ¢å¤åŸæ¥çš„ URL å’ŒçŠ¶æ€
                    history.pushState({ view: 'quiz', dbId: currentDb.id }, '', '#quiz');
                    return; // é˜»æ­¢ updateView æ‰§è¡Œï¼Œç•Œé¢ä¿æŒä¸å˜
                }
            }

            // --- æ™®é€šæ¨¡å¼é€»è¾‘ (æœªå˜) ---
            if (event.state) {
                updateView(event.state);
            } else {
                updateView({ view: 'home' });
            }
        };

        function setupDashboard(id) {
            const meta = getMeta().find(m => m.id === id);
            if (!meta) {
                history.pushState({ view: 'home' }, '', '#home');
                updateView({ view: 'home' });
                return;
            }

            const questions = JSON.parse(localStorage.getItem(`bingo_db_${id}`) || '[]');
            const progress = parseInt(localStorage.getItem(`bingo_prog_${id}`) || '0');
            currentDb = { ...meta, questions, progress };

            const wipData = localStorage.getItem(`bingo_wip_${id}`);
            const resumeBtn = document.getElementById('btn-resume-quiz');
            if (wipData) {
                const wipState = JSON.parse(wipData);
                const total = wipState.currentQuiz.length;
                const current = (wipState.lastVisibleQuestionIndex || 0) + 1;
                resumeBtn.innerHTML = `ç»§ç»­ä¸Šæ¬¡çš„è¿›åº¦ (${current}/${total} æ ¹)`;
                resumeBtn.style.display = 'block';
            } else {
                resumeBtn.style.display = 'none';
            }

            document.getElementById('dash-title').innerText = meta.name;
            document.getElementById('dash-count').innerText = questions.length;
            document.getElementById('dash-progress').innerText = `${progress} / ${questions.length}`;

            // --- æ–°å¢ä»£ç  START ---
            // è®¾ç½®é¡ºåºç»ƒä¹ çš„è¾“å…¥æ¡†é€»è¾‘
            const startInput = document.getElementById('sequence-start-input');
            const maxHint = document.getElementById('max-count-hint');

            // é»˜è®¤ä»å½“å‰è¿›åº¦+1å¼€å§‹ï¼ˆå¦‚æœæ˜¯0å°±æ˜¯1ï¼Œå¦‚æœæ˜¯10å°±æ˜¯11ï¼‰
            // å¦‚æœè¿›åº¦ç­‰äºæ€»æ•°ï¼Œä¸ºäº†æ–¹ä¾¿å¤ä¹ ï¼Œå¯ä»¥é‡ç½®ä¸º1ï¼Œæˆ–è€…ä¿æŒåœ¨æœ€å
            let defaultStart = progress >= questions.length ? 1 : progress + 1;

            startInput.value = defaultStart;
            startInput.max = questions.length;
            startInput.min = 1;
            maxHint.innerText = `(å…± ${questions.length} æ ¹)`;
            // --- æ–°å¢ä»£ç  END ---

            const categoryContainer = document.getElementById('category-container');
            const categorySelect = document.getElementById('category-select');
            const categories = [...new Set(questions.map(q => q.c || 'æœªåˆ†ç±»'))];

            if (categories.length > 1 || (categories.length === 1 && categories[0] !== 'æœªåˆ†ç±»')) {
                categorySelect.innerHTML = '<option value="all">å…¨éƒ¨</option>';
                categories.forEach(c => {
                    categorySelect.innerHTML += `<option value="${c}">${c}</option>`;
                });
                categoryContainer.style.display = 'block';
            } else {
                categoryContainer.style.display = 'none';
            }

            const allMeta = getMeta();
            const target = allMeta.find(m => m.id === id);
            if (target) {
                target.lastUsed = Date.now();
                saveMeta(allMeta);
            }

            renderHistoryList(id);
        }

        // --- åˆå§‹åŒ– ---
        window.onload = function () {
            initTheme();

            const currentHash = window.location.hash;
            if (currentHash.startsWith('#dashboard/')) {
                const dbId = currentHash.split('/')[1];
                history.replaceState({ view: 'dashboard', dbId: dbId }, '', currentHash);
                updateView({ view: 'dashboard', dbId: dbId });
            } else {
                history.replaceState({ view: 'home' }, '', '#home');
                updateView({ view: 'home' });
            }

            // PWAå®‰è£…é€»è¾‘
            const installBtn = document.getElementById('btn-install-pwa');
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredInstallPrompt = e;
                if (installBtn) installBtn.style.display = 'flex';
            });

            if (installBtn) {
                installBtn.addEventListener('click', async () => {
                    if (deferredInstallPrompt) {
                        deferredInstallPrompt.prompt();
                        await deferredInstallPrompt.userChoice;
                        deferredInstallPrompt = null;
                        installBtn.style.display = 'none';
                    }
                });
            }

            window.addEventListener('appinstalled', () => {
                deferredInstallPrompt = null;
                if (installBtn) installBtn.style.display = 'none';
            });

            initChildMode(); 
        };

        // --- ä¸»é¢˜åˆ‡æ¢ ---
        function initTheme() {
            const t = localStorage.getItem('app_theme');
            if (t) document.documentElement.setAttribute('data-theme', t);
        }
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.getAttribute('data-theme') === 'everforest';
            html.setAttribute('data-theme', isDark ? 'light' : 'everforest');
            localStorage.setItem('app_theme', isDark ? 'light' : 'everforest');
        }

        // --- æ»šåŠ¨ä½ç½®è¿½è¸ª ---
        let scrollTimeout;
        function handleQuizScroll() {
            if (scrollTimeout) clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                const quizNav = document.querySelector('#view-quiz .nav-bar');
                if (!quizNav) return;
                const quizNavHeight = quizNav.offsetHeight;
                const questionElements = document.querySelectorAll('#quiz-container .ios-card');

                for (let i = 0; i < questionElements.length; i++) {
                    const rect = questionElements[i].getBoundingClientRect();
                    if (rect.top >= quizNavHeight && rect.top < window.innerHeight) {
                        lastVisibleQuestionIndex = i;
                        return;
                    }
                }
            }, 150);
        }
        function setupQuizScrollListener() {
            window.addEventListener('scroll', handleQuizScroll, true);
        }
        function removeQuizScrollListener() {
            window.removeEventListener('scroll', handleQuizScroll, true);
        }

        // --- é¦–é¡µï¼šé¢˜åº“åˆ—è¡¨é€»è¾‘ ---
        function getMeta() { return JSON.parse(localStorage.getItem('bingo_meta') || '[]'); }
        function saveMeta(list) { localStorage.setItem('bingo_meta', JSON.stringify(list)); }

        function renderDbList() {
            const list = getMeta();
            const container = document.getElementById('db-list-container');
            const empty = document.getElementById('empty-state');

            container.innerHTML = '';
            if (list.length === 0) {
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            list.sort((a, b) => b.lastUsed - a.lastUsed);

            list.forEach(db => {
                const div = document.createElement('div');
                div.className = 'db-list-item ios-card';
                div.innerHTML = `
                <div class="db-info">
                    <h4>${db.name}</h4>
                    <p>å…± ${db.count} æ ¹éª¨å¤´ Â· ä¸Šæ¬¡å¼€å•ƒ ${new Date(db.lastUsed).toLocaleDateString()}</p>
                </div>
                <div style="color:var(--text-sub);">á³</div>
            `;
                div.onclick = () => openDashboard(db.id);
                container.appendChild(div);
            });
        }

        // --- å¯¼å…¥é€»è¾‘ (SheetJS) ---
        let tempImportData = null;

        function showImportModal() {
            document.getElementById('modal-import').style.display = 'flex';
            document.getElementById('import-feedback').style.display = 'none';
            document.getElementById('import-status').innerText = '';
            document.getElementById('import-loader').style.display = 'none';
            document.getElementById('import-preview').style.display = 'none';
            document.getElementById('btn-confirm-import').style.display = 'none';
            document.getElementById('btn-select-file').style.display = 'inline-flex';
        }
        function closeImportModal() {
            document.getElementById('modal-import').style.display = 'none';
            document.getElementById('file-input').value = '';
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            const feedbackContainer = document.getElementById('import-feedback');
            const loader = document.getElementById('import-loader');
            const status = document.getElementById('import-status');
            const preview = document.getElementById('import-preview');

            feedbackContainer.style.display = 'block';
            loader.style.display = 'block';
            status.innerText = '';
            preview.style.display = 'none';
            document.getElementById('btn-confirm-import').style.display = 'none';
            document.getElementById('btn-select-file').style.display = 'none';

            const reader = new FileReader();
            reader.onload = function (e) {
                loader.style.display = 'none';
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true },);

                    tempImportData = {};
                    const sheetSelectionContainer = document.getElementById('sheet-selection-container');
                    sheetSelectionContainer.innerHTML = '';

                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet, {
                            raw: false,
                            dateNF: 'yyyy/mm/dd' // ä½ å¯ä»¥æ”¹æˆ 'yyyy-mm-dd' æˆ–å…¶ä»–æ ¼å¼
                        });
                        const parsedData = parseImportData(json);
                        if (parsedData.length > 0) {
                            tempImportData[sheetName] = parsedData;

                            const checkbox = document.createElement('div');
                            checkbox.innerHTML = `
                            <label>
                                <input type="checkbox" name="sheet" value="${sheetName}" checked>
                                ${sheetName} (${parsedData.length} æ ¹éª¨å¤´)
                            </label>
                        `;
                            sheetSelectionContainer.appendChild(checkbox);
                        }
                    });

                    if (Object.keys(tempImportData).length > 0) {
                        feedbackContainer.style.display = 'none';
                        preview.style.display = 'block';
                        document.getElementById('btn-confirm-import').style.display = 'inline-block';
                    } else {
                        status.innerText = 'è§£æå¤±è´¥ï¼è¯·æ£€æŸ¥æ‚¨çš„ Excel æ–‡ä»¶ï¼Œç¡®ä¿å…¶ä¸­åŒ…å« "é¢˜ç›®" å’Œ "ç­”æ¡ˆ" åˆ—ã€‚';
                        document.getElementById('btn-select-file').style.display = 'inline-flex';
                    }
                } catch (err) {
                    console.error("File parsing error:", err);
                    status.innerText = 'æ–‡ä»¶è¯»å–å‡ºé”™ï¼Œå¯èƒ½ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ Excel æ–‡ä»¶ã€‚';
                    document.getElementById('btn-select-file').style.display = 'inline-flex';
                }
            };
            reader.onerror = function () {
                loader.style.display = 'none';
                status.innerText = 'æ— æ³•è¯»å–æ–‡ä»¶ã€‚';
                document.getElementById('btn-select-file').style.display = 'inline-flex';
            };
            reader.readAsArrayBuffer(file);
        }

        function parseImportData(json) {
            const parsed = json.map(row => {
                const qKey = Object.keys(row).find(k => /é¢˜ç›®|é—®é¢˜|Question/i.test(k));
                const aKey = Object.keys(row).find(k => /ç­”æ¡ˆ|Answer/i.test(k));
                const eKey = Object.keys(row).find(k => /è§£æ|è§£é‡Š|Explanation/i.test(k));
                const tKey = Object.keys(row).find(k => /é¢˜å‹|Type/i.test(k));
                const cKey = Object.keys(row).find(k => /ç±»åˆ«|åˆ†ç±»|Category/i.test(k));

                if (!qKey || !aKey) return null;

                const options = {};
                ['A', 'B', 'C', 'D', 'E', 'F'].forEach(opt => {
                    const optKey = Object.keys(row).find(k => k.toUpperCase().trim() === `é€‰é¡¹${opt}` || k.toUpperCase().trim() === opt);
                    if (optKey && row[optKey]) options[opt] = row[optKey];
                });

                let cleanAns = String(row[aKey]).toUpperCase().replace(/[^A-Z]/g, '');

                if (Object.keys(options).length === 0 && (String(row[aKey]).includes('å¯¹') || String(row[aKey]).includes('é”™'))) {
                    options['A'] = 'æ­£ç¡®'; options['B'] = 'é”™è¯¯';
                    if (String(row[aKey]).includes('å¯¹')) cleanAns = 'A';
                    if (String(row[aKey]).includes('é”™')) cleanAns = 'B';
                }

                return {
                    q: row[qKey],
                    a: cleanAns,
                    o: options,
                    e: eKey ? row[eKey] : '',
                    t: tKey ? row[tKey] : (cleanAns.length > 1 ? 'å¤šé€‰' : 'å•é€‰'),
                    c: cKey ? row[cKey] : 'æœªåˆ†ç±»'
                };
            }).filter(item => item !== null);
            return parsed;
        }

        // --- æ ¸å¿ƒä¿®æ”¹ï¼šæ”¯æŒæ›´æ–°é¢˜åº“å¹¶ä¿ç•™è¿›åº¦çš„å¯¼å…¥é€»è¾‘ ---
        function confirmImport() {
            const selectedSheets = Array.from(document.querySelectorAll('#sheet-selection-container input[name="sheet"]:checked'))
                .map(input => input.value);

            if (selectedSheets.length === 0) {
                alert('æ€»å¾—é€‰ä¸ªåœ°æ–¹æŒ–å§ï¼Ÿ');
                return;
            }

            const meta = getMeta(); // è·å–ç°æœ‰é¢˜åº“åˆ—è¡¨
            let updatedCount = 0;
            let newCount = 0;

            selectedSheets.forEach(sheetName => {
                const data = tempImportData[sheetName];

                // 1. æ£€æŸ¥æ˜¯å¦å­˜åœ¨åŒåé¢˜åº“
                const existingDb = meta.find(m => m.name === sheetName);

                if (existingDb) {
                    // 2. å¦‚æœå­˜åœ¨ï¼Œè¯¢é—®ç”¨æˆ·æ„å›¾
                    const userWantsUpdate = confirm(
                        `å‘ç°å·²å­˜åœ¨çš„ç‹—çªï¼šã€${sheetName}ã€‘\n\n` +
                        `ğŸ¦´ ç‚¹å‡»ã€ç¡®å®šã€‘ï¼šæ›´æ–°é¢˜ç›®ï¼Œä½†ä¿ç•™ä½ çš„åˆ·é¢˜è¿›åº¦å’Œå†å²æˆç»©ã€‚\n` +
                        `ğŸ†• ç‚¹å‡»ã€å–æ¶ˆã€‘ï¼šæŠŠå®ƒå½“ä½œä¸€ä¸ªæ–°çš„ç‹—çªå¯¼å…¥ï¼ˆä¸è¦†ç›–æ—§çš„ï¼‰ã€‚`
                    );

                    if (userWantsUpdate) {
                        // --- A. æ›´æ–°æ¨¡å¼ ---
                        try {
                            // è¦†ç›–é¢˜ç›®æ•°æ®
                            localStorage.setItem(`bingo_db_${existingDb.id}`, JSON.stringify(data));

                            // æ›´æ–°å…ƒæ•°æ®ä¸­çš„æ•°é‡å’Œæ—¶é—´
                            existingDb.count = data.length;
                            existingDb.lastUsed = Date.now();

                            // å…³é”®ï¼šæ¸…é™¤â€œä¸­æ–­æš‚å­˜â€çš„çŠ¶æ€ã€‚å› ä¸ºé¢˜ç›®å˜äº†ï¼Œä¹‹å‰çš„æ–­ç‚¹å¯èƒ½å¯¹åº”ä¸ä¸Šï¼Œé˜²æ­¢æŠ¥é”™ã€‚
                            localStorage.removeItem(`bingo_wip_${existingDb.id}`);

                            // ä¿®æ­£è¿›åº¦ï¼šå¦‚æœæ–°é¢˜ç›®å˜å°‘äº†ï¼Œè€Œä½ è¿›åº¦å·²ç»è¶…å‡ºäº†æ–°æ€»æ•°ï¼ŒæŠŠè¿›åº¦é‡ç½®ä¸ºæœ€å¤§å€¼
                            let currentProg = parseInt(localStorage.getItem(`bingo_prog_${existingDb.id}`) || '0');
                            if (currentProg > data.length) {
                                localStorage.setItem(`bingo_prog_${existingDb.id}`, data.length);
                                existingDb.progress = data.length; // å¦‚æœå†…å­˜ä¸­æœ‰ä¹Ÿè¦æ›´æ–°
                            }

                            updatedCount++;
                        } catch (e) {
                            alert('æ›´æ–°å¤±è´¥ï¼Œå¯èƒ½æ˜¯å­˜å‚¨ç©ºé—´ä¸è¶³ï¼');
                            console.error(e);
                        }
                    } else {
                        // --- B. æ–°å»ºæ¨¡å¼ (ç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆ) ---
                        createNewDb(sheetName, data, meta);
                        newCount++;
                    }
                } else {
                    // --- C. æ–°å»ºæ¨¡å¼ (åŸæœ¬å°±ä¸å­˜åœ¨) ---
                    createNewDb(sheetName, data, meta);
                    newCount++;
                }
            });

            saveMeta(meta);
            closeImportModal();
            renderDbList(); // åˆ·æ–°åˆ—è¡¨

            // æç¤ºç»“æœ
            if (updatedCount > 0 || newCount > 0) {
                alert(`æ±ªï¼æ“ä½œå®Œæˆï¼š\nğŸ›  æ›´æ–°äº† ${updatedCount} ä¸ªæ—§ç‹—çª\nâœ¨ æŒ–æ˜äº† ${newCount} ä¸ªæ–°ç‹—çª`);
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºæ–°é¢˜åº“
        function createNewDb(name, data, metaArray) {
            try {
                const id = Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem(`bingo_db_${id}`, JSON.stringify(data));
                metaArray.push({ id, name: name, count: data.length, lastUsed: Date.now() });
            } catch (e) {
                alert(`å¯¼å…¥ã€${name}ã€‘å¤±è´¥ï¼Œç‹—çªæ»¡äº†ï¼ˆå­˜å‚¨ç©ºé—´ä¸è¶³ï¼‰ï¼å¿«ä¸¢æ‰ç‚¹æ—§éª¨å¤´ã€‚`);
            }
        }

        // --- ä»ªè¡¨ç›˜é€»è¾‘ ---
        function saveWipQuiz() {
            // ã€ä¿®æ”¹ã€‘å¦‚æœæ˜¯æ¨¡æ‹Ÿè€ƒè¯•ï¼Œç»å¯¹ä¸ä¿å­˜è¿›åº¦ï¼Œè¿™æ„å‘³ç€åˆ·æ–°æˆ–å¼ºé€€åæ— æ³•â€œç»§ç»­â€
            if (!currentDb || !currentQuiz.length || isReviewMode || quizType === 'mock_exam') return;

            const wipState = {
                quizType: quizType,
                currentQuiz: currentQuiz,
                userAnswers: userAnswers,
                lastVisibleQuestionIndex: lastVisibleQuestionIndex
            };
            localStorage.setItem(`bingo_wip_${currentDb.id}`, JSON.stringify(wipState));
        }

        function handleQuizExit() {
            // å¦‚æœæ˜¯æ¨¡æ‹Ÿè€ƒè¯•æ¨¡å¼ï¼Œä¸”å¹¶ä¸æ˜¯åœ¨å›çœ‹é”™é¢˜ï¼ˆæ˜¯åœ¨ç­”é¢˜ä¸­ï¼‰
            if (quizType === 'mock_exam' && !isReviewMode) {
                // å¼¹å‡ºè­¦å‘Š
                if (confirm('âš ï¸ æ­£åœ¨æ¨¡æ‹Ÿè€ƒè¯•ä¸­ï¼\n\nç°åœ¨é€€å‡ºå°†å¼ºåˆ¶äº¤å·å¹¶ç”Ÿæˆæˆç»©å•ï¼Œä¸”æ— æ³•æ’¤é”€ã€‚\n\nç¡®å®šè¦äº¤å·å—ï¼Ÿ')) {
                    // å‚æ•° true ä»£è¡¨è‡ªåŠ¨äº¤å·ï¼Œä¸å†æ¬¡å¼¹çª—ç¡®è®¤
                    submitPaper(true);
                    // æ³¨æ„ï¼šsubmitPaper ä¼šæ‰“å¼€æˆç»© Modalï¼Œç”¨æˆ·å¯ä»¥åœ¨æˆç»©å•ä¸Šç‚¹å‡»â€œå›ç‹—çªâ€ç¦»å¼€
                }
            } else {
                // æ™®é€šæ¨¡å¼ï¼Œç›´æ¥è¿”å›
                history.back();
            }
        }

        function clearWipQuiz() {
            if (currentDb) localStorage.removeItem(`bingo_wip_${currentDb.id}`);
        }

        function openDashboard(id) {
            history.pushState({ view: 'dashboard', dbId: id }, '', `#dashboard/${id}`);
            updateView({ view: 'dashboard', dbId: id });
        }

        function goHome() {
            history.pushState({ view: 'home' }, '', '#home');
            updateView({ view: 'home' });
        }

        function deleteCurrentDb() {
            if (!confirm('çœŸè¦æŠŠè¿™çªéª¨å¤´éƒ½æ‰”äº†ï¼Ÿå†ä¹Ÿæ‰¾ä¸å›äº†å“¦ï¼')) return;

            const id = currentDb.id;
            localStorage.removeItem(`bingo_db_${id}`);
            localStorage.removeItem(`bingo_prog_${id}`);
            localStorage.removeItem(`bingo_hist_${id}`);
            localStorage.removeItem(`bingo_wip_${id}`);

            const meta = getMeta().filter(m => m.id !== id);
            saveMeta(meta);

            goHome();
        }

        function deleteAllData() {
            if (!confirm('ã€é«˜å±æ“ä½œã€‘è­¦å‘Šï¼æ­¤æ“ä½œå°†å½»åº•åˆ é™¤æ‰€æœ‰é¢˜åº“ã€ç»ƒä¹ å†å²å’Œè®¾ç½®ï¼Œä¸”æ— æ³•æ¢å¤ã€‚æ‚¨ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç‹—çªå—ï¼Ÿ')) return;
            if (!confirm('ã€äºŒæ¬¡ç¡®è®¤ã€‘çœŸçš„ï¼Œæ‰€æœ‰ä¸œè¥¿éƒ½æ²¡äº†ï¼Œç¡®å®šå—ï¼Ÿ')) return;

            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('bingo_') || key === 'app_theme') {
                    localStorage.removeItem(key);
                }
            });

            alert('æ‰€æœ‰ç‹—çªå’Œéª¨å¤´éƒ½å·²ä¸¢æ‰ï¼');
            location.reload();
        }

        function getAllWrongQuestions(dbId) {
            const history = JSON.parse(localStorage.getItem(`bingo_hist_${dbId}`) || '[]');
            const wrongQuestions = {};

            history.forEach(record => {
                if (!record.quizSnapshot || !record.userAnswers) return;

                record.quizSnapshot.forEach((question, index) => {
                    const userAnswer = record.userAnswers[index] || '';
                    if (userAnswer !== question.a) {
                        wrongQuestions[question.q] = question;
                    }
                });
            });

            return Object.values(wrongQuestions);
        }

        function startWrongAnswerQuiz() {
            const wipData = localStorage.getItem(`bingo_wip_${currentDb.id}`);
            if (wipData) {
                if (!confirm('æ±ªï¼ä½ ä¹‹å‰è—çš„éª¨å¤´è¿˜æ²¡å•ƒå®Œå‘¢ï¼Œç°åœ¨å°±è¦æŒ–ä¸ªæ–°å‘å—ï¼Ÿæ—§å‘é‡Œçš„éª¨å¤´å¯å°±æ²¡å’¯ï¼')) {
                    return;
                }
            }
            clearWipQuiz();
            const wrongQuestions = getAllWrongQuestions(currentDb.id);

            if (wrongQuestions.length === 0) {
                alert('å¤ªæ£’äº†ï¼Œæ²¡æœ‰å‘ç°é”™é¢˜ï¼ä½ å°±æ˜¯æœ€èªæ˜çš„æ–Œç‹—ï¼');
                return;
            }

            quizType = 'wrong_review';
            isReviewMode = false;
            userAnswers = {};
            masteredInSession = 0;
            currentQuiz = wrongQuestions.sort(() => 0.5 - Math.random());
            lastVisibleQuestionIndex = 0;

            history.pushState({ view: 'quiz', dbId: currentDb.id }, '', '#quiz');
            updateView({ view: 'quiz' });

            document.getElementById('quiz-fab-area').style.display = 'flex';
            renderQuizItems();
            saveWipQuiz();
            setupQuizScrollListener();
            window.addEventListener('beforeunload', saveWipQuiz);
        }

        // --- å†å²è®°å½• ---
        function renderHistoryList(dbId) {
            const list = JSON.parse(localStorage.getItem(`bingo_hist_${dbId}`) || '[]');
            const container = document.getElementById('history-list');
            container.innerHTML = '';

            if (list.length === 0) {
                document.getElementById('no-history-btn').style.display = 'block';
            } else {
                document.getElementById('no-history-btn').style.display = 'none';
                list.slice().reverse().slice(0, 10).forEach((item, index) => {
                    const originalIndex = list.length - 1 - index;
                    const scoreClass = item.score >= 90 ? 'score-high' : (item.score < 60 ? 'score-low' : '');
                    const el = document.createElement('div');
                    el.className = 'history-item';

                    let quizName = 'éšä¾¿åˆ¨ä¸€ä¸ª';
                    if (item.type === 'sequence') quizName = 'æŒ‰åºå¼€å•ƒ';
                    if (item.type === 'mock_exam') quizName = 'æ¨¡æ‹Ÿå¼€å•ƒ';

                    el.innerHTML = `
                    <div style="flex-grow: 1; cursor: pointer;" onclick="loadReview(${originalIndex})">
                        <div style="font-weight:bold; font-size:14px;">${quizName}</div>
                        <div style="font-size:12px; color:var(--text-sub);">${new Date(item.date).toLocaleString()}</div>
                    </div>
                    <div class="score-badge ${scoreClass}">${item.score}</div>
                    <button class="btn-delete-hist" onclick="event.stopPropagation(); deleteHistoryRecord(${originalIndex})">Ã—</button>
                `;
                    container.appendChild(el);
                });
            }

            const wrongQuestions = getAllWrongQuestions(dbId);
            const wrongAnswersBtn = document.getElementById('btn-wrong-answers');
            if (wrongQuestions.length > 0) {
                wrongAnswersBtn.style.display = 'block';
                wrongAnswersBtn.innerText = `å•ƒç¡¬éª¨å¤´ (${wrongQuestions.length} æ ¹)`;
            } else {
                wrongAnswersBtn.style.display = 'none';
            }
        }

        function deleteHistoryRecord(index) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å•ƒéª¨å¤´è®°å¿†å—ï¼Ÿ')) return;

            const historyKey = `bingo_hist_${currentDb.id}`;
            let history = JSON.parse(localStorage.getItem(historyKey) || '[]');

            history.splice(index, 1);

            localStorage.setItem(historyKey, JSON.stringify(history));
            renderHistoryList(currentDb.id);
        }

        // --- ä¿®å¤åçš„ resumeQuiz å‡½æ•° ---
        function resumeQuiz() {
            const wipData = localStorage.getItem(`bingo_wip_${currentDb.id}`);
            if (!wipData) {
                console.error("No WIP data found to resume.");
                return;
            }

            const wipState = JSON.parse(wipData);
            currentQuiz = wipState.currentQuiz;
            userAnswers = wipState.userAnswers;
            quizType = wipState.quizType;
            isReviewMode = false;
            lastVisibleQuestionIndex = wipState.lastVisibleQuestionIndex || 0;

            history.pushState({ view: 'quiz', dbId: currentDb.id }, '', '#quiz');
            updateView({ view: 'quiz' });
            document.getElementById('quiz-fab-area').style.display = 'flex';

            renderQuizItems();
            setupQuizScrollListener();
            window.addEventListener('beforeunload', saveWipQuiz);

            setTimeout(() => {
                const targetEl = document.getElementById(`q-${lastVisibleQuestionIndex}`);
                if (targetEl) {
                    targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // å¢åŠ ä¸´æ—¶é«˜äº®
                    targetEl.style.transition = 'outline 0.2s ease-in-out';
                    targetEl.style.outline = '3px solid var(--primary)';
                    setTimeout(() => {
                        targetEl.style.outline = 'none';
                    }, 1500);
                }
            }, 100);

            if (quizType === 'mock_exam') {
                const count = currentQuiz.length;
                const totalTime = count * 90;
                // æ¢å¤è€ƒè¯•æ—¶ç®€å•é‡ç½®è®¡æ—¶å™¨ï¼ˆç®€åŒ–å¤„ç†ï¼Œä¸è®°å¿†å‰©ä½™æ—¶é—´ï¼‰
                startTimer(totalTime);
            }
        }

        // --- ä¿®å¤åçš„ loadReview å‡½æ•° ---
        function loadReview(historyIndex) {
            const id = currentDb.id;
            const list = JSON.parse(localStorage.getItem(`bingo_hist_${id}`) || '[]');
            const record = list[historyIndex];

            if (!record) return;

            currentQuiz = record.quizSnapshot;
            userAnswers = record.userAnswers;
            isReviewMode = true;

            history.pushState({ view: 'quiz', dbId: id, history: true }, '', '#quiz');
            updateView({ view: 'quiz' });
            document.getElementById('quiz-fab-area').style.display = 'none'; // å›çœ‹ä¸èƒ½äº¤å·

            renderQuizItems();
        }

        // --- æ¨¡æ‹Ÿè€ƒè¯•é€»è¾‘ ---
        let quizTimer = null;
        let timeLeft = 0;

        function startTimer(duration) {
            stopTimer();
            timeLeft = duration;
            updateTimerDisplay();
            quizTimer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    stopTimer();
                    alert('æ—¶é—´åˆ°ï¼Œè‡ªåŠ¨äº¤å·ï¼');
                    submitPaper(true);
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(quizTimer);
            quizTimer = null;
            document.getElementById('quiz-timer').innerText = '';
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timerEl = document.getElementById('quiz-timer');
            timerEl.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            if (timeLeft <= 30 && timeLeft > 10) {
                timerEl.style.color = 'var(--primary)';
            } else if (timeLeft <= 10) {
                timerEl.style.color = 'var(--danger)';
            } else {
                timerEl.style.color = 'var(--primary)';
            }
        }

        function startMockExam() {
            // ã€é‡è¦ä¿®å¤ã€‘è¿™é‡Œåˆ é™¤äº† clearWipQuiz(); 
            // è¿™æ ·æ¨¡æ‹Ÿè€ƒè¯•å°±ä¸ä¼šæ¸…ç©ºä¹‹å‰çš„â€œç»§ç»­è¿›åº¦â€

            const count = parseInt(document.getElementById('mock-exam-count').value);
            const totalTime = count * 90;

            const selectedCategory = document.getElementById('category-select')?.value;
            let questionsForQuiz = currentDb.questions;

            if (selectedCategory && selectedCategory !== 'all') {
                questionsForQuiz = currentDb.questions.filter(q => (q.c || 'æœªåˆ†ç±»') === selectedCategory);
            }

            const shuffled = [...questionsForQuiz].sort(() => 0.5 - Math.random());
            currentQuiz = shuffled.slice(0, count);

            if (currentQuiz.length === 0) {
                return alert('è¿™ä¸ªåˆ†ç±»ä¸‹æ²¡æœ‰è¶³å¤Ÿçš„éª¨å¤´è¿›è¡Œæ¨¡æ‹Ÿï¼');
            }

            quizType = 'mock_exam';
            isReviewMode = false;
            userAnswers = {};
            lastVisibleQuestionIndex = 0;

            history.pushState({ view: 'quiz', dbId: currentDb.id }, '', '#quiz');
            updateView({ view: 'quiz' });
            history.pushState({ view: 'quiz', dbId: currentDb.id }, '', '#quiz');
            document.getElementById('quiz-fab-area').style.display = 'flex';

            renderQuizItems();
            // saveWipQuiz();
            setupQuizScrollListener();
            // window.addEventListener('beforeunload', saveWipQuiz);

            startTimer(totalTime);
        }

        function finishExamAndExit() {
            // å½»åº•æ¸…ç†çŠ¶æ€
            quizType = null;
            currentQuiz = [];
            userAnswers = {};
            document.getElementById('modal-score').style.display = 'none';
            history.back(); // è¿”å›ä»ªè¡¨ç›˜
        }

        // --- ç­”é¢˜é€»è¾‘ ---
        function startQuiz(type) {
            const wipData = localStorage.getItem(`bingo_wip_${currentDb.id}`);
            if (wipData) {
                if (!confirm('æ±ªï¼ä½ ä¹‹å‰è—çš„éª¨å¤´è¿˜æ²¡å•ƒå®Œå‘¢ï¼Œç°åœ¨å°±è¦æŒ–ä¸ªæ–°å‘å—ï¼Ÿæ—§å‘é‡Œçš„éª¨å¤´å¯å°±æ²¡å’¯ï¼')) {
                    return;
                }
            }
            clearWipQuiz();
            quizType = type;
            isReviewMode = false;
            userAnswers = {};
            lastVisibleQuestionIndex = 0;

            const selectedCategory = document.getElementById('category-select')?.value;
            let questionsForQuiz = currentDb.questions;

            // å¤„ç†åˆ†ç±»ç­›é€‰
            if (selectedCategory && selectedCategory !== 'all') {
                questionsForQuiz = currentDb.questions.filter(q => (q.c || 'æœªåˆ†ç±»') === selectedCategory);
            }

            if (type === 'random') {
                // éšæœºæ¨¡å¼
                const countValue = document.getElementById('random-count').value;
                const count = countValue === 'all' ? questionsForQuiz.length : parseInt(countValue);
                const shuffled = [...questionsForQuiz].sort(() => 0.5 - Math.random());
                currentQuiz = shuffled.slice(0, count);
            } else {
                // é¡ºåºæ¨¡å¼ (ä¿®å¤ç‰ˆ)
                const countValue = document.getElementById('sequence-count').value;
                const totalQuestions = questionsForQuiz.length;
                const count = countValue === 'all' ? totalQuestions : parseInt(countValue);

                // 1. è·å–è¾“å…¥æ¡†çš„å€¼
                let inputStart = parseInt(document.getElementById('sequence-start-input').value);

                // 2. æ ¡éªŒåˆæ³•æ€§
                if (isNaN(inputStart) || inputStart < 1) inputStart = 1;
                // å¦‚æœè¾“å…¥è¶…è¿‡æ€»æ•°ï¼Œè‡ªåŠ¨ä¿®æ­£ä¸ºæœ€åä¸€é¢˜ï¼ˆæˆ–è€…ä¹Ÿå¯ä»¥æç¤ºç”¨æˆ·ï¼‰
                // è¿™é‡Œä¸åšå¼ºåˆ¶ä¿®æ­£ä¸ºæ€»æ•°ï¼Œå…è®¸é€»è¾‘åˆ¤æ–­åç»­æ˜¯å¦ä¸ºç©º

                // 3. è®¡ç®—æ•°ç»„ç´¢å¼• (è¾“å…¥æ˜¯1å¼€å§‹ï¼Œç´¢å¼•æ˜¯0å¼€å§‹)
                const startIndex = inputStart - 1;

                // 4. åˆ‡ç‰‡
                if (countValue === 'all') {
                    currentQuiz = questionsForQuiz.slice(startIndex);
                } else {
                    currentQuiz = questionsForQuiz.slice(startIndex, startIndex + count);
                }

                // 5. ç©ºæ•°æ®å¤„ç†
                if (currentQuiz.length === 0) {
                    // å¦‚æœæ˜¯å› ä¸ºå…¶å®ä½ç½®è¶…è¿‡äº†æ€»æ•°
                    if (startIndex >= totalQuestions) {
                        if (confirm('è¿™å°±å•ƒåˆ°åº•å•¦ï¼è¦ä»ç¬¬ 1 æ ¹é‡æ–°å¼€å§‹å—ï¼Ÿ')) {
                            document.getElementById('sequence-start-input').value = 1;
                            startQuiz('sequence'); // é€’å½’è°ƒç”¨ï¼Œé‡æ–°å¼€å§‹
                            return;
                        }
                    }
                    return alert('è¿™ä¸ªä½ç½®åé¢æ²¡æœ‰éª¨å¤´å•¦ï¼è¯·è°ƒæ•´èµ·å§‹ä½ç½®ã€‚');
                }
            }

            history.pushState({ view: 'quiz', dbId: currentDb.id }, '', '#quiz');
            updateView({ view: 'quiz' });
            document.getElementById('quiz-fab-area').style.display = 'flex';

            renderQuizItems();
            saveWipQuiz();
            setupQuizScrollListener();
            window.addEventListener('beforeunload', saveWipQuiz);
        }

        function renderQuizItems() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = '';
            const bodyClass = isReviewMode ? 'review-mode' : '';
            container.className = bodyClass;

            document.getElementById('quiz-progress-text').innerText = `æœ¬è½® ${currentQuiz.length} æ ¹éª¨å¤´`;

            currentQuiz.forEach((item, idx) => {
                const uAns = userAnswers[idx] || '';
                let cardClass = 'ios-card';
                let analysisHtml = '';
                let masteredButtonHtml = '';
                let peekButtonHtml = '';

                if (quizType === 'wrong_review' && !isReviewMode) {
                    masteredButtonHtml = `<button class="btn-mastered" onclick="masterHardBone(${idx})">æˆ‘å•ƒä¼šäº†</button>`;
                }

                const answerContent = `
                    <div style="font-weight:bold; margin-bottom:4px;">
                        æ±ªçš„ç­”æ¡ˆï¼š<span style="color:var(--success)">${item.a}</span>
                        ${isReviewMode && uAns !== item.a ? `<span style="margin-left:10px; color:var(--danger)">ä½ åˆ¨çš„ï¼š${uAns || 'æœªé€‰'}</span>` : ''}
                    </div>
                    <div style="color:var(--text-sub);">${item.e || 'åªèƒ½æ„ä¼š'}</div>
                `;

                if (isReviewMode) {
                    const isCorrect = uAns === item.a;
                    cardClass += isCorrect ? ' correct' : ' wrong';
                    analysisHtml = `<div style="margin-top:15px; padding:10px; background:var(--bg-input); border-radius:8px; font-size:14px;">${answerContent}</div>`;
                } else if (quizType !== 'mock_exam') {
                    peekButtonHtml = `<div style="text-align:right; margin-top:10px;"><button class="btn-peek" onclick="toggleAnalysis(${idx})">ğŸ‘€ å·å·çœ‹ä¸€çœ¼</button></div>`;
                    analysisHtml = `<div class="analysis-box" id="analysis-${idx}" style="display:none;">${answerContent}</div>`;
                }


                let optionsHtml = '';
                for (let key in item.o) {
                    const isSelected = uAns.includes(key) ? 'selected' : '';
                    const isRealAnswer = isReviewMode && item.a.includes(key) ? 'correct-answer' : '';

                    optionsHtml += `
                    <div class="option-row ${isSelected} ${isRealAnswer}" onclick="selectOption(${idx}, '${key}', '${item.t}')">
                        <div class="option-circle">${key}</div>
                        <div style="flex:1">${item.o[key]}</div>
                    </div>
                `;
                }

                let ttsHtml = `
    <button class="btn-tts" onclick="speakText('${item.q.replace(/'/g, "\\'")}')">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
    </button>
`;

                const html = `
                <div class="${cardClass}" id="q-${idx}">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom:10px;">
                        <span style="font-weight:600; font-size:17px; line-height:1.4; padding-right: 15px;">
                            <span class="bingo-badge" style="margin-left:0; margin-right:5px;">${item.t || 'å•é€‰'}</span>
                            ${idx + 1}. ${item.q}
                        </span>
                        ${ttsHtml}
                        ${masteredButtonHtml}
                    </div>
                    <div>${optionsHtml}</div>
                    ${peekButtonHtml}
                    ${analysisHtml}
                </div>
            `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function speakText(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); // åœæ­¢ä¹‹å‰çš„æœ—è¯»
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN'; // è®¾ç½®ä¸ºä¸­æ–‡
                utterance.rate = 0.9; // è¯­é€Ÿç¨æ…¢ä¸€ç‚¹
                window.speechSynthesis.speak(utterance);
            } else {
                alert('æŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæœ—è¯»åŠŸèƒ½ã€‚');
            }
        }


        function masterHardBone(qIdx) {
            if (!confirm('ç¡®å®šæŠŠè¿™æ ¹éª¨å¤´ä»ç¡¬éª¨å¤´é‡Œæ‰”æ‰å—ï¼Ÿä»¥åç­”é”™äº†è¿˜æ˜¯ä¼šå›æ¥çš„å“¦ã€‚')) return;

            const questionToMaster = currentQuiz[qIdx];
            if (!questionToMaster) return;

            const questionText = questionToMaster.q;
            const historyKey = `bingo_hist_${currentDb.id}`;
            let history = JSON.parse(localStorage.getItem(historyKey) || '[]');

            history.forEach(record => {
                if (!record.quizSnapshot || !record.userAnswers) return;

                record.quizSnapshot.forEach((question, index) => {
                    if (question.q === questionText) {
                        if (record.userAnswers[index] !== question.a) {
                            record.userAnswers[index] = question.a;
                        }
                    }
                });
            });

            localStorage.setItem(historyKey, JSON.stringify(history));

            const cardElement = document.getElementById(`q-${qIdx}`);
            if (cardElement) {
                cardElement.style.transition = 'opacity 0.3s, transform 0.3s';
                cardElement.style.opacity = '0';
                cardElement.style.transform = 'scale(0.95)';
                setTimeout(() => { cardElement.style.display = 'none'; }, 300);
            }

            masteredInSession++;
            const totalInQuiz = currentQuiz.length;
            document.getElementById('quiz-progress-text').innerText = `æœ¬è½® ${totalInQuiz - masteredInSession} / ${totalInQuiz} æ ¹`;

            alert('è¿™æ ¹éª¨å¤´ä½ å·²ç»å•ƒä¼šäº†ï¼');
        }

        function selectOption(qIdx, optKey, type) {
            if (isReviewMode) return;

            // --- å„¿ç«¥æ¨¡å¼é€»è¾‘ START ---
            if (isChildMode) {
                const currentQuestion = currentQuiz[qIdx];
                const correctAns = currentQuestion.a;
                const row = event.currentTarget; // è·å–ç‚¹å‡»çš„è¡Œ

                // ç®€å•çš„é˜²é‡å¤ç‚¹å‡»
                if (row.classList.contains('locked')) return;

                if (optKey === correctAns || (type.includes('å¤š') && correctAns.includes(optKey))) {
                    // ç­”å¯¹äº†ï¼
                    // 1. æ’­æ”¾éŸ³æ•ˆ (è¿™é‡Œç”¨ç®€å•çš„æŒ¯åŠ¨ä»£æ›¿ï¼Œå¦‚æœä½ æœ‰mp3å¯ä»¥play())
                    if (navigator.vibrate) navigator.vibrate(50);

                    // 2. è§†è§‰åé¦ˆ
                    row.style.background = 'var(--success)';
                    row.style.color = 'white';
                    row.querySelector('.option-circle').style.borderColor = 'white';

                    // 3. å¼¹å‡ºå¤¸å¥–é®ç½©
                    setTimeout(() => {
                        showChildFeedback();
                    }, 300);

                    // è®°å½•ç­”æ¡ˆï¼ˆä¸ºäº†ä¿æŒå…¼å®¹æ€§ï¼Œè™½ç„¶å„¿ç«¥æ¨¡å¼é€šå¸¸ä¸äº¤å·ï¼‰
                    userAnswers[qIdx] = correctAns;

                } else {
                    // ç­”é”™äº†ï¼
                    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);

                    // æ‘‡æ™ƒåŠ¨ç”»
                    row.classList.add('shake-it');
                    setTimeout(() => {
                        row.classList.remove('shake-it');
                    }, 400);

                    // ä¹Ÿå¯ä»¥é€‰æ‹©è®©è¯­éŸ³è¯´â€œä¸å¯¹å“¦â€
                }
                return; // é˜»æ­¢æ‰§è¡Œåé¢çš„æ™®é€šæ¨¡å¼é€»è¾‘
            }
            // --- å„¿ç«¥æ¨¡å¼é€»è¾‘ END ---

            const isMulti = type.includes('å¤š');
            let current = userAnswers[qIdx] || '';

            if (!isMulti) {
                current = optKey;
            } else {
                if (current.includes(optKey)) {
                    current = current.replace(optKey, '');
                } else {
                    current += optKey;
                }
                current = current.split('').sort().join('');
            }

            userAnswers[qIdx] = current;
            saveWipQuiz();

            const card = document.getElementById(`q-${qIdx}`);
            const rows = card.querySelectorAll('.option-row');
            rows.forEach(row => {
                const k = row.querySelector('.option-circle').innerText;
                if (isMulti) {
                    if (current.includes(k)) row.classList.add('selected');
                    else row.classList.remove('selected');
                } else {
                    if (k === current) row.classList.add('selected');
                    else row.classList.remove('selected');
                }
            });
        }

        // å„¿ç«¥æ¨¡å¼ä¸“ç”¨ï¼šæ˜¾ç¤ºåé¦ˆ
        function showChildFeedback() {
            const feedback = document.getElementById('child-feedback');
            const stars = ['â­', 'ğŸŒŸ', 'ğŸŒˆ', 'ğŸ­', 'ğŸ¶', 'ğŸ’¯'];
            const randomStar = stars[Math.floor(Math.random() * stars.length)];
            const titles = ['å¤ªæ£’äº†ï¼', 'Bingoï¼', 'çœŸèªæ˜ï¼', 'ç­”å¯¹äº†ï¼', 'å“‡å¡ï¼'];

            feedback.querySelector('.child-star').innerText = randomStar;
            feedback.querySelector('h2').innerText = titles[Math.floor(Math.random() * titles.length)];
            feedback.style.display = 'flex';
        }

        // å„¿ç«¥æ¨¡å¼ä¸“ç”¨ï¼šä¸‹ä¸€é¢˜
        function nextChildQuestion() {
            document.getElementById('child-feedback').style.display = 'none';

            // æ»šåŠ¨åˆ°ä¸‹ä¸€é¢˜
            const nextIdx = lastVisibleQuestionIndex + 1;
            if (nextIdx < currentQuiz.length) {
                const nextEl = document.getElementById(`q-${nextIdx}`);
                if (nextEl) {
                    nextEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    lastVisibleQuestionIndex = nextIdx;
                }
            } else {
                // å…¨åšå®Œäº†
                alert('å“‡ï¼æ‰€æœ‰çš„éª¨å¤´éƒ½å•ƒå®Œäº†ï¼ä½ çœŸæ˜¯ä¸ªå°å¤©æ‰ï¼');
                // å¯é€‰æ‹©é‡ç½®æˆ–è¿”å›
                history.back();
            }
        }

        function toggleAnalysis(qIdx) {
            const analysisEl = document.getElementById(`analysis-${qIdx}`);
            if (analysisEl) {
                analysisEl.style.display = analysisEl.style.display === 'block' ? 'none' : 'block';
            }
        }

        // --- æ–°å¢: ä¿å­˜å†å²è®°å½• (ä¿®å¤ç¼ºå¤±å‡½æ•°) ---
        function saveHistory(score, type) {
            if (!currentDb) return;
            const id = currentDb.id;
            const histKey = `bingo_hist_${id}`;
            const history = JSON.parse(localStorage.getItem(histKey) || '[]');

            const record = {
                date: Date.now(),
                score: score,
                type: type,
                quizSnapshot: currentQuiz, // ä¿å­˜å½“æ—¶çš„é¢˜ç›®å¿«ç…§
                userAnswers: userAnswers   // ä¿å­˜ç”¨æˆ·ç­”æ¡ˆ
            };

            history.push(record);
            localStorage.setItem(histKey, JSON.stringify(history));

            // ...
            // å¦‚æœæ˜¯é¡ºåºç»ƒä¹ ï¼Œæ›´æ–°è¿›åº¦
            if (type === 'sequence') {
                const currentProg = parseInt(localStorage.getItem(`bingo_prog_${id}`)) || 0;

                // è®¡ç®—è¿™æ‰¹é¢˜ç›®çš„ç»“æŸä½ç½®ç´¢å¼• (åŸºäºé¢˜ç›®åœ¨åŸå§‹æ•°ç»„ä¸­çš„ä½ç½®)
                // æ³¨æ„ï¼šè¿™éœ€è¦æˆ‘ä»¬çŸ¥é“ currentQuiz é‡Œçš„é¢˜ç›®åœ¨åŸå§‹ questions é‡Œçš„ indexã€‚
                // ç”±äºä½ çš„æ•°æ®ç»“æ„æ²¡å­˜ IDï¼Œæˆ‘ä»¬ç®€åŒ–å¤„ç†ï¼š
                // å‡è®¾æ˜¯æŒ‰é¡ºåºåˆ‡ç‰‡çš„ï¼Œé‚£ä¹ˆç”¨æˆ·çš„ "èµ·å§‹ä½ç½®è¾“å…¥æ¡†" + "å½“å‰é¢˜ç›®æ•°é‡" = æ–°çš„æ½œåœ¨è¿›åº¦

                const startInputVal = parseInt(document.getElementById('sequence-start-input').value) || 1;
                const potentialNewProg = (startInputVal - 1) + currentQuiz.length;

                // åªæœ‰å½“æ–°çš„è¿›åº¦æ¯”æ—§è¿›åº¦å¤§æ—¶ï¼Œæ‰æ›´æ–° (é¿å…å¤ä¹ æ—§é¢˜æ—¶æŠŠè¿›åº¦è¦†ç›–å›å»)
                if (potentialNewProg > currentProg) {
                    let newProg = potentialNewProg;
                    // é˜²æ­¢æº¢å‡º
                    if (newProg > currentDb.questions.length) newProg = currentDb.questions.length;

                    localStorage.setItem(`bingo_prog_${id}`, newProg);
                    currentDb.progress = newProg;
                }
            }
            // ...

        }

        function submitPaper(autoSubmit = false) {
            if (!autoSubmit && !confirm('ä¸æ”¹äº†ï¼ŸçœŸçš„äº¤å·äº†å“¦ï¼Ÿ')) return;

            stopTimer();
            removeQuizScrollListener();
            window.removeEventListener('beforeunload', saveWipQuiz); // ç§»é™¤ä¿å­˜ç›‘å¬

            let correctCount = 0;
            currentQuiz.forEach((q, i) => {
                if ((userAnswers[i] || '') === q.a) correctCount++;
            });

            const score = Math.round((currentQuiz.length > 0 ? (correctCount / currentQuiz.length) : 0) * 100);

            // è®°å½•å†å²ï¼ˆæ¨¡æ‹Ÿè€ƒè¯•å¿…é¡»è®°å½•ï¼‰
            // æ³¨æ„ï¼šwrong_review æ¨¡å¼é€šå¸¸ä¸è®°å½•åˆ†æ•°å†å²ï¼Œæˆ–è€…ä½ å¯ä»¥è‡ªè¡Œå†³å®š
            saveHistory(score, quizType);

            // ã€é‡è¦ä¿®å¤ã€‘åªæœ‰éæ¨¡æ‹Ÿè€ƒè¯•ï¼Œæ‰æ¸…ç©º WIP
            // å› ä¸ºæ¨¡æ‹Ÿè€ƒè¯•æœ¬èº«å°±ä¸ä¿å­˜ WIPï¼Œæ‰€ä»¥å¦‚æœè¿™é‡Œæ— è„‘æ¸…ç©ºï¼Œä¼šæŠŠä¹‹å‰çš„æ™®é€šç»ƒä¹ è¿›åº¦åˆ æ‰
            if (quizType !== 'mock_exam') {
                clearWipQuiz();
            }

            lastCompletedQuiz = currentQuiz;
            lastCompletedAnswers = userAnswers;

            // æ¸…ç†ç°åœºï¼šä¸è¦åœ¨è¿™é‡Œè°ƒç”¨ clearWipQuiz()ï¼Œå› ä¸ºå®ƒå·²ç»åœ¨ä¸Šé¢æ ¹æ®æ¡ä»¶åˆ¤æ–­è¿‡äº†

            document.getElementById('result-score').innerText = score;
            document.getElementById('modal-score').style.display = 'flex';

            // ã€æ–°å¢ã€‘å¦‚æœæ˜¯æ¨¡æ‹Ÿè€ƒï¼Œéšè—åº•éƒ¨çš„æäº¤æŒ‰é’®ï¼Œé˜²æ­¢ç”¨æˆ·å…³æ‰Modalååœ¨è¿™ä¸ªé¡µé¢è¿·èŒ«
            if (quizType === 'mock_exam') {
                document.getElementById('quiz-fab-area').style.display = 'none';
            }
        }

        function enterReviewMode() {
            document.getElementById('modal-score').style.display = 'none';

            currentQuiz = lastCompletedQuiz;
            userAnswers = lastCompletedAnswers;

            isReviewMode = true;

            updateView({ view: 'quiz' });
            document.getElementById('quiz-fab-area').style.display = 'none';
            renderQuizItems();
            window.scrollTo(0, 0);
        }

        function exitQuiz() {
            if (quizType === 'mock_exam' && !isReviewMode) {
                if (confirm('æ‚¨æ­£åœ¨è¿›è¡Œæ¨¡æ‹Ÿå¼€å•ƒï¼Œç°åœ¨é€€å‡ºå°†ç›´æ¥äº¤å·ï¼Œç¡®å®šå—ï¼Ÿ')) {
                    submitPaper(true);
                } else {
                    return;
                }
            }

            if (!isReviewMode) {
                saveWipQuiz();
            }

            history.back();
        }

    </script>
<script type="module">
    import TinyGesture from 'https://cdn.jsdelivr.net/npm/tinygesture@3.0.0/dist/TinyGesture.min.js';
    window.TinyGesture = TinyGesture;
</script>

    <script>
        // --- å…¨å±€é˜²æ‰‹æ»‘åˆ·æ–°/å…³é—­ ---
        window.addEventListener('beforeunload', function (e) {
            // åªæœ‰åœ¨æ¨¡æ‹Ÿè€ƒè¯•ä¸”æœªäº¤å·æ—¶æ‰æ‹¦æˆª
            if (quizType === 'mock_exam' && !isReviewMode) {
                // æ ‡å‡†åšæ³•ï¼Œè™½ç„¶ç°ä»£æµè§ˆå™¨å¯èƒ½ä¸ä¼šæ˜¾ç¤ºè‡ªå®šä¹‰æ–‡æœ¬ï¼Œä½†ä¼šå¼¹å‡ºé»˜è®¤è­¦å‘Š
                e.preventDefault();
                e.returnValue = 'æ­£åœ¨è€ƒè¯•ä¸­ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
                return 'æ­£åœ¨è€ƒè¯•ä¸­ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
            }
            // æ™®é€šç»ƒä¹ æ—¶ï¼Œæˆ‘ä»¬æœ‰ saveWipQuiz è‡ªåŠ¨ä¿å­˜ï¼Œæ‰€ä»¥ä¸éœ€è¦æ‹¦æˆªï¼Œè®©å®ƒç›´æ¥å…³
        });

        // --- æ‰‹åŠ¿å¤„ç† (ä¼˜åŒ–ç‰ˆ) ---
        window.addEventListener('load', () => {
            try {
                // åˆå§‹åŒ–æ‰‹åŠ¿åº“
                const gesture = new TinyGesture(document.body);

                // ç›‘å¬å³æ»‘äº‹ä»¶ (Swipe Right)
                gesture.on('swiperight', (event) => {
                    const dashboardView = document.getElementById('view-dashboard');
                    const quizView = document.getElementById('view-quiz');

                    // 1. å¦‚æœåœ¨ä»ªè¡¨ç›˜ç•Œé¢ï¼Œå³æ»‘ = è¿”å›é¦–é¡µ
                    if (dashboardView.style.display === 'block') {
                        // é˜²æ­¢åœ¨è¾“å…¥æ¡†æˆ–é€‰æ‹©æ–‡å­—æ—¶è¯¯è§¦
                        if (event.target.tagName === 'INPUT' ||
                            event.target.tagName === 'SELECT' ||
                            window.getSelection().toString()) return;

                        history.back();
                    }

                    // 2. å¦‚æœåœ¨ç­”é¢˜ç•Œé¢ï¼Œå³æ»‘ = é€€å‡º/äº¤å·
                    if (quizView.style.display === 'block') {
                        // é˜²æ­¢åœ¨è¾“å…¥æ¡†æˆ–é€‰æ‹©æ–‡å­—æ—¶è¯¯è§¦
                        if (event.target.tagName === 'INPUT' ||
                            event.target.tagName === 'SELECT' ||
                            window.getSelection().toString()) return;

                        // æ ¸å¿ƒé€»è¾‘ä¿®æ”¹ï¼š
                        // å¦‚æœæ˜¯ã€æ¨¡æ‹Ÿè€ƒè¯•ã€‘ä¸”ã€éå›çœ‹æ¨¡å¼ã€‘ï¼Œè°ƒç”¨ handleQuizExit() æ¥è§¦å‘å¼¹çª—é€»è¾‘
                        if (quizType === 'mock_exam' && !isReviewMode) {
                            handleQuizExit();
                        } else {
                            // å…¶ä»–æƒ…å†µï¼ˆæ™®é€šç»ƒä¹ ã€å›çœ‹æ¨¡å¼ï¼‰ï¼Œç›´æ¥ä¿å­˜è¿›åº¦å¹¶è¿”å›
                            if (!isReviewMode) {
                                saveWipQuiz(); // ç¡®ä¿æ™®é€šç»ƒä¹ æ‰‹åŠ¿é€€å‡ºä¹Ÿèƒ½ä¿å­˜è¿›åº¦
                            }
                            history.back();
                        }
                    }
                });
            } catch (e) {
                console.log("Gesture library load failed or not compatible", e);
            }
        });
        let isChildMode = false;

        // åˆå§‹åŒ–æ—¶æ£€æŸ¥
        function initChildMode() {
            const mode = localStorage.getItem('app_mode');
            if (mode === 'child') {
                enableChildMode(true);
            }
        }

        // åˆ‡æ¢å¼€å…³
        function toggleChildMode() {
            isChildMode = !isChildMode;
            enableChildMode(isChildMode);
        }

        function enableChildMode(enable) {
            isChildMode = enable;
            const html = document.documentElement;
            const icon = document.getElementById('child-icon');

            if (enable) {
                html.setAttribute('data-mode', 'child');
                localStorage.setItem('app_mode', 'child');
                icon.innerText = 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§'; // å˜æˆâ€œé€€å‡ºå„¿ç«¥æ¨¡å¼â€çš„å›¾æ ‡
                // å„¿ç«¥æ¨¡å¼ä¸‹å¼ºåˆ¶æµ…è‰²ä¸»é¢˜ï¼Œé¿å…çœ‹ç€å‹æŠ‘
                html.setAttribute('data-theme', 'light');
            } else {
                html.removeAttribute('data-mode');
                localStorage.setItem('app_mode', 'normal');
                icon.innerText = 'ğŸ‘¶';
                // æ¢å¤åŸæ¥çš„ä¸»é¢˜
                initTheme();
            }

            // å¦‚æœå½“å‰åœ¨åˆ—è¡¨é¡µæˆ–ä»ªè¡¨ç›˜ï¼Œåˆ·æ–°ä¸€ä¸‹ç•Œé¢ä»¥éšè—/æ˜¾ç¤ºæŒ‰é’®
            if (document.getElementById('view-home').style.display === 'block') renderDbList();
            if (document.getElementById('view-dashboard').style.display === 'block' && currentDb) setupDashboard(currentDb.id);
        }


    </script>
    <!-- å„¿ç«¥æ¨¡å¼åé¦ˆé®ç½© -->
    <div id="child-feedback" class="child-feedback-modal" onclick="nextChildQuestion()">
        <div class="child-star">â­</div>
        <h2 style="color:var(--primary); margin-top:20px; font-size: 30px;">å¤ªæ£’å•¦ï¼</h2>
        <p style="color:var(--text-sub);">ç‚¹å‡»å±å¹•ç»§ç»­</p>
    </div>

</body>

</html>